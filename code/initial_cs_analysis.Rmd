---
title: "A systematic review and meta-analysis of care seeking for diarrheal illness"
author: "Kirsten E. Wiens, Marissa Miller, Daniel P. Costello, Ashlynn Solomon, ..., Elizabeth C. Lee, Andrew S. Azman"
output: 
  html_document:
    toc: true
    toc_float: true
---

<br>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      dev=c('png', 'pdf'), fig.path='figures/')
knitr::opts_knit$set(root.dir = here::here())
```

```{r preamble, warning = TRUE}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  countrycode, here, readxl, lubridate, tidyverse, ggplot2, doParallel, boot, meta,
  sf, raster, RColorBrewer, cowplot, kableExtra, flextable, scales, RVAideMemoire
)

# custom functions
source(here::here('code', 'utils.R'))
```

## Outline

#### Our primary question is: What proportion of people with diarrhea seek care at a place that they'd likely get counted (i.e., hospital/clinic) when they have diarrhea?

1)  Look at care seeking in the raw data by:

    -   Symptoms/case definition
    -   Sampling method
    -   Study type
    -   Urban/rural
    -   How study question is phrased (multiple choice, timing of care seeking, recall period)
    -   Study population/respondent
    -   Outbreak setting
    -   Income group
    -   Geographic region
    -   Age

2)  Estimate proportion seeking care at hospital or clinic overall, following methods from Wiens et al PLOS Med

3)  Compare with results if we were to run a RE meta-analysis using default settings in metafor/meta package

4)  Examine differences by age in studies with age stratifications

5)  Examine factors associated with care seeking at a hospital or clinical

#### Our secondary question is: Where else do they seek care?

1)  Look at care seeking in the raw data by variables that came out as key in main analysis:

    -   Symptoms/case definition
    -   Income group
    -   Timing of care seeking
    -   Age

<br>

```{r load and tidy data}

# load systematic review data
df <- read.csv(here::here('data', 'extracted_data', 'data_extractions.csv'))
vars <- read.csv(here::here('data', 'extracted_data', 'data_codebook.csv'))

# load world bank income classifications
wb <- read_xlsx(here::here('data', 'extracted_data', 'wb_income_class.xlsx')) %>%
  data.frame() %>%
  rename(country_iso3 = Code,
         income_group = Income.group)

# set column variable names
df$Status <- NULL
if(nrow(vars) != ncol(df)) stop('Codebook does not match extractions. Please check variables.')
names(df) <- vars$Variable

# filter to primary non-overlapping dataset
df <- df %>%
  filter(primary_set == 1)

# format columns
df <- df %>%
  # simplify/clarify location description
  mutate(location_desc = ifelse(location_desc == 'IDP Camp (Internally Displaced Person) or Refugee Camp',
                                'IDP or Refugee Camp', 
                                ifelse(location_desc == 'Both', 'Urban and Rural', location_desc))) %>%
  # add start and end year
  mutate(sampling_start = as.Date(sampling_start, format = "%m/%d/%Y"),
         sampling_end = as.Date(sampling_end, format = "%m/%d/%Y"),
         TL = year(sampling_start),
         TR = year(sampling_end)) %>%
  # region as defined by World Bank Development Indicators
  mutate(region = countrycode(country_iso3, 
                              origin = 'iso3c', 
                              destination = 'region')) %>%
  mutate(region = ifelse(region != 'Sub-Saharan Africa',
                         region, 
                         countrycode(country_iso3, 
                                     origin = 'iso3c', 
                                     destination = 'region23'))) %>%
  # income category as defined by world bank
  left_join(wb %>% dplyr::select(country_iso3, income_group)) %>%
  mutate(hic = ifelse(income_group == 'High income', 1, 0),
         income_group = factor(income_group, levels = c('Low income', 'Lower middle income',
                                                        'Upper middle income', 'High income'))) %>%
  # whether or not an outbreak description was provided
  mutate(outbreak_desc = ifelse(outbreak == 'No outbreak description' | outbreak == 'Pre outbreak', 0, 1)) %>%
  # set "other" to "any care" for timing (based on descriptions in notes)
  mutate(time_care = ifelse(time_care == 'Other (write in notes)', 'Any care', time_care)) %>%
  # clean up self or child
  mutate(self_or_child = ifelse(self_or_child == 'Other (describe in notes)', 'Other', self_or_child)) %>%
  # create standard case definitions
  mutate(case_cat = ifelse(case_cat %in% c('Giardiasis', 'Other (list etiologies in notes)'), 'Gastroenteritis or non-Vc etiologies', 
                           ifelse(case_cat %in% c('No explicit diarrhea definition', 'Diarrhea (3+ loose/liquid stools)'), 'Diarrhea',
                                  ifelse(case_cat %in% c('Diarrhea death', 'Severe diarrhea (danger signs, dehydration, hospitalization, 1+ week)', 
                                                         'Cholera (watery diarrhea)', 'Cholera death'), 'Severe diarrhea or cholera',
                                                                'Gastroenteritis or non-Vc etiologies'))))

# main dataset is whether people DID seek care; also create df for when people WOULD seek care
df_would <- df %>%
  filter(!is.na(n_would_survey)) %>%
  dplyr::select(-n_did_survey, -n_did)

df <- df %>%
  filter(!is.na(n_did_survey)) %>%
  dplyr::select(-n_would_survey, -n_would)
```

## Systematic review

### Fig 1. PRISMA diagram

![PRISMA diagram.](PRISMA-20231218.png)

<br>

## Data

**Note:** Unless otherwise noted, the data presented below represents 161 studies (381 stratified observation entries) in the **primary, non-overlapping** dataset that asked study participants whether or not the **DID** seek care for a past diarrheal illness.

We also have information on whether individuals **would** seek care for a hypothetical diarrheal illness from 27 studies (96 stratified observation entries).

### Data coverage by geography

```{r, warning= FALSE}
# shapefile
shp <- st_read(here::here('data/shapefiles/ne_50m_admin_0_countries/ne_50m_admin_0_countries.shp'), quiet = TRUE)
shp <- shp %>% dplyr::select(ISO_A3, NAME_SORT, geometry)
```

```{r match-polygons}
# match each entry_id to a polygon
shp_list <- readRDS(here::here("data", "shapefiles", "shp_list.RData"))
# shp_list contains three shapefiles (shp_admin0, shp_admin1, shp_admin2), e.g. if the minimal admin level of an entry is 0 (country level), the shapefile can be found in shp_admin0. If an entry contains more than one place, the were separated into different rows, each has its own polygon.
```

Number of stratified observation entries in the primary dataset at each administrative level by country. Countries with \>10 observations displayed as 10.

```{r figS1, fig.height = 10, fig.width = 7, warning = FALSE}
data_loc <- df %>% 
  # select relevant study-period columns
  dplyr::select(c('study_id', 'entry_id', 'country_iso3', 'region',
                  'admin0', 'admin1', 'admin2', 'admin3', 'place_name')) %>%
  unique() %>%
  # only keep location names for lowest admin level
  mutate(admin0 = ifelse(admin1 == '' & admin2 == '' & admin3 == '', admin0, ''),
         admin1 = ifelse(admin2 == '' & admin3 == '', admin1, ''),
         admin2 = ifelse(admin3 == '', admin2, '')) %>%
  # reshape for counting
  reshape2::melt(measure.vars = c('admin0', 'admin1', 'admin2', 'admin3'),
                 id.vars = c('study_id', 'entry_id', 'country_iso3', 'region')) %>%
  # largest administrative level by observation
  filter(value != '') %>%
  group_by_at(c('study_id', 'entry_id', 'country_iso3', 'region')) %>%
  summarize(largest_admin = min(as.character(variable))) %>%
  ungroup() %>%
  # count observations by admin level
  count(country_iso3, region, largest_admin) %>% 
  rename(variable = largest_admin, observations = n) %>%
  ungroup()

# plot for each admin level
figS1 <- list()
for (i in 0:3) {
  figS1[[i+1]] <- data_map(data_loc, shp, ad = paste0('admin', i))
}

cowplot::plot_grid(figS1[[1]], figS1[[2]], figS1[[3]], figS1[[4]],
                   labels = c('A', 'B', 'C', 'D'),
                   ncol = 1)


# number at each level
data_loc %>%
  group_by(variable) %>%
  # count observations by admin level
  summarize(observations = sum(observations)) %>%
  ungroup() %>%
  pretty_table()

# number in each region
data_loc %>%
  group_by(region) %>%
  # count observations by admin level
  summarize(observations = sum(observations)) %>%
  ungroup() %>%
  arrange(observations) %>%
  pretty_table()

# # numbers for Haiti
# data_loc %>%
#   filter(country_iso3 == 'HTI') %>%
#   group_by(variable) %>%
#   # count observations by admin level
#   summarize(observations = sum(observations)) %>%
#   ungroup() %>%
#   pretty_table()
```

<br>

### Data coverage over time

Number of stratified observation entries in the primary dataset within different time periods. Year represents the year sampling was completed. Excludes 6 entries missing study dates.

```{r figS2, fig.height = 10, fig.width = 7}
# similar to those above, but instead of stratification by admin level, stratify into 4 time periods (before 2000~2004, 2005~2009, 2010~2014, after 2015)
coverage_time <- df %>%
  # select relevant study-period columns
  dplyr::select(study_id, entry_id, country_iso3, sampling_end) %>%
  unique() %>%
  mutate(time_period = case_when(sampling_end <= as.Date("2004-12-31") ~ "2000~2004",
                                 sampling_end > as.Date("2004-12-31") & sampling_end <= as.Date("2009-12-31") ~ "2005~2009",
                                 sampling_end > as.Date("2009-12-31") & sampling_end <= as.Date("2014-12-31") ~ "2010~2014",
                                 sampling_end > as.Date("2014-12-31") ~ "2015~2022")) %>%
  # if multiple sampling periods within a time period, only report one observation
  dplyr::select(-sampling_end) %>%
  unique() %>%
  # if observations span multiple time periods, just report the end of the study period
  arrange(time_period) %>%
  group_by_at(c('study_id', 'entry_id', 'country_iso3')) %>% 
  mutate(num_dups = n(), 
         dup_id = row_number()) %>% 
  ungroup() %>% 
  mutate(is_duplicated = dup_id > 1) %>%
  filter(is_duplicated==FALSE) %>%
  dplyr::select(-is_duplicated) %>%
  # count by time (study ending time)
  count(country_iso3, time_period) %>% 
  rename(variable = time_period, observations = n) %>%
  ungroup()

# plot for each time period
figS2 <- list()
for (i in c("2000~2004", "2005~2009", "2010~2014", "2015~2022")) {
  figS2[[i]] <- data_map(coverage_time, shp, ad = i)
}

cowplot::plot_grid(figS2[[1]], figS2[[2]], figS2[[3]], figS2[[4]],
                   labels = c('A', 'B', 'C', 'D'),
                   ncol = 1)

# number at each level
coverage_time %>%
  group_by(variable) %>%
  # count observations by time period
  summarize(observations = sum(observations)) %>%
  ungroup() %>%
  pretty_table()

# # numbers for Haiti
# coverage_time %>%
#   filter(country_iso3 == 'HTI') %>%
#   group_by(variable) %>%
#   # count observations by time period
#   summarize(observations = sum(observations)) %>%
#   ungroup() %>%
#   pretty_table()
```

<br>

### Study (entry_id) characteristics

```{r table1}

# prep variables for table
sd <- df %>% 
  # format variables
  mutate(outbreak_desc = ifelse(outbreak_desc == 1, 'Yes', 'No')) %>%
  # sum up number of tests and sample sizes by observation
  dplyr::select(c('entry_id', 'study_type', 'sampling_method', 'pop_cat', 'case_cat',
                  'income_group', 'outbreak_desc', 'location_desc')) %>%
  unique() %>%
  dplyr::select(-entry_id) 


# tmp <- df %>% 
#   # format variables
#   mutate(outbreak_desc = ifelse(outbreak_desc == 1, 'Yes', 'No')) %>%
#   # sum up number of tests and sample sizes by observation
#   dplyr::select(c('entry_id', 'study_type', 'sampling_method', 'pop_cat', 'case_cat', 'recall_time',
#                   'income_group', 'outbreak_desc', 'location_desc')) %>%
#   unique() %>%
#   dplyr::select(-entry_id) %>%
#   filter(recall_time > 30)
# 
# table(tmp$case_cat)

# summarize and make table
sd %>%
  summarize_cats() %>%
  arrange(desc(variable), desc(Percent)) %>%
  mutate(variable = ifelse(variable == 'Pop cat', 'Study population',
                           ifelse(variable == 'Case cat', 'Case definition',
                                  ifelse(variable == 'Outbreak desc', 'Outbreak described', variable)))) %>%
  pretty_table()

# sd %>%
#   summarize_cats() %>%
#   flextable() %>%
#   save_as_docx(path = here::here('code/tables/table1.docx'))
```

<br>

### Care seeking questions

**Note:** "Other" regarding self or child almost always refers to all household members, or is a combination of self and child that we could not disaggregate.

```{r table2}

# prep variables for table
cq <- df %>% 
  # format variables
  mutate(recall_time = ifelse(recall_time < 14, '2-7 days',
                                   ifelse(recall_time == 14 | recall_time == 15, '14-15 days',
                                          ifelse(recall_time > 15 & recall_time <= 30, '27-30 days', 
                                                 ifelse(recall_time > 30 & recall_time <= 90, '42-90 days',
                                                        ifelse(recall_time > 90, '170-365 days', 'Unknown'))))),
         mult_choice = ifelse(mult_choice == 1, 'Yes', 'No')) %>%
  # sum up number of tests and sample sizes by observation
  dplyr::select(c('entry_id', 'mult_choice', 'time_care', 'self_or_child', 'recall_time')) %>%
  unique() %>%
  dplyr::select(-entry_id) 

# summarize and make table
cq %>%
  summarize_cats() %>%
  arrange(desc(variable), desc(Percent)) %>%
  pretty_table()

# cq %>%
#   summarize_cats() %>%
#   flextable() %>%
#   save_as_docx(path = here::here('code/tables/table1.docx'))
```

<br>

### Proportion seeking care at a hospital or clinic

**Note:** This excludes individuals seeking care exclusively or explicitly at private hospitals/clinics, i.e., this includes location categories "Hospital/Clinic" (general) and "Public Hospital/Clinic" (more specific).

*For multiple choice questions where there is more than one category of hospital/clinic, we take the largest proportion that sought care across them. This is not entirely accurate but the best we can do here. May want to return to this.*

<br>

#### By study (entry_id) characteristics

```{r}
df_hosp <- df %>%
  # filter to hospital/clinic (not private)
  filter(location_type %in% c('Hospital/Clinic', 'Public Hospital/Clinic')) %>%
  # aggregate care seeking
  group_by_at(c('entry_id', 'entry_desc', 'region', 'study_type', 'sampling_method', 'pop_cat', 
                'case_cat', 'outbreak_desc', 'location_desc', 'income_group', 'hic',
                'mult_choice', 'time_care', 'self_or_child', 'recall_time')) %>%
  summarize(n_did_survey = n_did_survey,
            n_did = ifelse(mult_choice == 0, sum(n_did), max(n_did))) %>%
  ungroup() %>%
  unique() %>%
  # proportion seeking care
  mutate(prop_seek = n_did/n_did_survey) %>%
  # format variables
  mutate(region = ifelse(region %in% c('Eastern Africa', 'Middle Africa', 'Southern Africa', 'Western Africa'), 
                         'sub-Saharan Africa', region),
         outbreak_desc = ifelse(outbreak_desc == 1, 'Yes', 'No'),
         mult_choice = ifelse(mult_choice == 1, 'Yes', 'No'),
         pop_cat = ifelse(pop_cat %in% c('Child with malnutrition', 'Orphan', 'Relative/Caregiver (of adult)',
                                         'Street dweller', 'University student'), 'Other', pop_cat),
         recall_time = ifelse(recall_time < 14, '2-7 days',
                                   ifelse(recall_time == 14 | recall_time == 15, '14-15 days',
                                          ifelse(recall_time > 15 & recall_time <= 30, '27-30 days', 
                                                 ifelse(recall_time > 30 & recall_time <= 90, '42-90 days',
                                                        ifelse(recall_time > 90, '170-365 days', 'Unknown'))))),
         recall_time = factor(recall_time, 
                              levels = c('2-7 days', '14-15 days', '27-30 days', '42-90 days', '170-365 days', 'Unknown'))) %>%
  # factor variables
  mutate(study_type = factor(study_type,
                             levels = c('Survey', 'Surveillance',
                                        'Intervention', 'Case control')),
         sampling_method = factor(sampling_method,
                                  levels = c('Cluster', 'Systematic',
                                             'Simple random', 'All cases or households',
                                             'Stratified', 'Other')),
         location_desc = factor(location_desc,
                                levels = c('Rural', 'Urban', 'Urban and Rural',
                                           'Peri-Urban', 'Urban and Peri-Urban', 'IDP or Refugee Camp')))
         
```

```{r}
f2a <- plot_seekprop(df_hosp, 'study_type', num_colors=4)

# df_hosp %>%
#   group_by(study_type) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()

f2c <- plot_seekprop(df_hosp, 'sampling_method', num_colors=6)

# df_hosp %>%
#   group_by(sampling_method) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()

# # overall
# df_hosp %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r}
f2b <- plot_seekprop(df_hosp, 'outbreak_desc', num_colors=2) +
  ggtitle('Study describes an outbreak')

# df_hosp %>%
#   group_by(outbreak_desc) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r}
f2d <- plot_seekprop(df_hosp, 'location_desc', num_colors=6) +
  ggtitle('Location description')

# df_hosp %>%
#   group_by(location_desc) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r fig2, fig.width = 9, fig.height = 4}
cowplot::plot_grid(f2a, f2b,
                   labels = c('A', 'B'),
                   nrow = 1, rel_widths = c(0.6, 0.4))

cowplot::plot_grid(f2c, labels = c('C'))
cowplot::plot_grid(f2d, labels = c('D'))
```

```{r}
f2e <- plot_seekprop(df_hosp, 'pop_cat', num_colors=8) +
  ggtitle('Study population / respondent')

# df_hosp %>%
#   group_by(pop_cat) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r}
f2f <- plot_seekprop(df_hosp, 'case_cat', num_colors=8) +
  ggtitle('Diarrhea case definition')

# df_hosp %>%
#   group_by(case_cat) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r fig2-2, fig.width = 9, fig.height = 9}
cowplot::plot_grid(f2e, f2f,
                   labels = c('E', 'F'),
                   nrow = 2)
```

```{r}
f2g <- plot_seekprop(df_hosp, 'income_group', num_colors=8) +
  ggtitle('World bank income classification & case definition') +
  facet_wrap('case_cat', ncol = 1)

# df_hosp %>%
#   group_by(income_group) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r, fig.width = 5, fig.height = 9}
cowplot::plot_grid(f2g, labels = c('G'), nrow = 1)
```

```{r}
f2h <- plot_seekprop(df_hosp, 'region', num_colors=10) +
  ggtitle('Geographic region (HIC and LMIC)')

# df_hosp %>%
#   group_by(region) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r, fig.width = 8, fig.height = 4}
cowplot::plot_grid(f2h, labels = c('H'), nrow = 1)
```

```{r}
f2i <- plot_seekprop(df_hosp %>% filter(hic==0), 'region', num_colors=10) +
  ggtitle('Geographic region (LMIC)')

# df_hosp %>% filter(hic==0) %>%
#   group_by(region) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r, fig.width = 6, fig.height = 4}
cowplot::plot_grid(f2i, labels = c('I'), nrow = 1)
```

```{r}
f2j <- plot_seekprop(df_hosp %>% filter(hic==0), 'region', num_colors=10) +
  ggtitle('Geographic region (LMIC) & case definition') +
  facet_wrap('case_cat', ncol = 1)

# df_hosp %>% filter(hic==0) %>%
#   group_by(region) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r, fig.width = 7, fig.height = 9}
cowplot::plot_grid(f2j, labels = c('J'), nrow = 1)
```

<br>

#### By type of care seeking questions

```{r}
f3a <- plot_seekprop(df_hosp, 'time_care', num_colors=3) +
  ggtitle('Timing of care seeking')

# df_hosp %>%
#   group_by(time_care) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r}
f3b <- plot_seekprop(df_hosp, 'self_or_child', num_colors=3) +
  ggtitle('Self, child, or other/combination')

# df_hosp %>%
#   group_by(self_or_child) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r}
f3c <- plot_seekprop(df_hosp, 'recall_time', num_colors=5) +
  ggtitle('Recall period')

# df_hosp %>%
#   group_by(recall_time) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r}
f3d <- plot_seekprop(df_hosp, 'mult_choice', num_colors=2) +
  ggtitle('Multiple choice')

# df_hosp %>%
#   group_by(mult_choice) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r fig3, fig.width = 9, fig.height = 4}
cowplot::plot_grid(f3a, f3b,
                   labels = c('A', 'B'),
                   nrow = 1)

cowplot::plot_grid(f3c, f3d,
                   labels = c('C', 'D'),
                   nrow = 1, rel_widths = c(0.64, 0.35))
```

<br>

### Care seeking at hospital/clinic by age

```{r}
#TODO: consider pulling non-primary dataset here; would need to double check that age-stratified entries flagged in this column no not overlap

# set variables to keep
vars <- c('time_care', 'recall_time', 'pop_cat', 'mult_choice', 'self_or_child',
          'case_cat', 'outbreak_desc', 'location_desc', 'prop_five', 'strat_age')

df_age <- df %>%
  # filter to hospital/clinic (not private) and diarrhea (general)
  filter(location_type %in% c('Hospital/Clinic', 'Public Hospital/Clinic')) %>%
  # aggregate care seeking to entry_id, accounting for multiple choice questions
  group_by_at(c('entry_id', 'study_id', 'country_iso3', 'region', 'hic', 'income_group', vars, 'age_L', 'age_R')) %>%
  summarize(n_did_survey = n_did_survey,
            n_did = ifelse(mult_choice == 0, sum(n_did), max(n_did))) %>%
  ungroup() %>%
  unique() %>%
  # format variables, combining some to reduce combinations
  mutate(pop_cat = ifelse(pop_cat %in% c('Child with malnutrition', 'Orphan', 'Relative/Caregiver (of adult)',
                                         'Street dweller', 'University student', 'Other',
                                         'Resident', 'Resident with telephone/email access'), 'Other resident', pop_cat),
         location_desc = ifelse(location_desc == 'Urban', 'Urban',
                                ifelse(location_desc %in% c('Rural', 'Peri-Urban', 'IDP or Refugee Camp'), 'Non-urban', 
                                       'Urban and non-urban')),
         recall_time = ifelse(recall_time <= 30, 'under30', 'over30_orNA'),
         recall_time = ifelse(is.na(recall_time), 'over30_orNA', recall_time)) %>%
  # aggregate care seeking numbers to study_id and covariate categories ("observations")
  group_by_at(c('study_id', 'country_iso3', 'region', 'hic', 'income_group', vars)) %>%
  summarize(n_did_survey = sum(n_did_survey), 
            n_did = sum(n_did)) %>%
  ungroup() %>%
  unique() %>%
  # proportion seeking care
  mutate(prop_seek = n_did/n_did_survey)
```

#### Relationship between care seeking and proportion under 5 years {.tabset}

##### Overall

```{r, fig.width = 6}
df_cor <- df_age %>%
  na.omit()

ct <- spearman.ci(df_cor$prop_seek, df_cor$prop_five)
ct_p <- cor.test(df_cor$prop_seek, df_cor$prop_five, method = 'spearman')

# plot relationship between prop under 5 and care seeking overall
ggplot(df_cor, aes(y=prop_seek, x = prop_five)) +
  geom_point(alpha = 0.6, aes(size = n_did_survey)) +
  theme_bw() +
  #theme(legend.position = 'bottom') +
  annotate('text', x = 0.5, y = 1.1, color = 'darkgreen',
           label = paste0('Spearman rho = ', signif(ct$estimate, 2), 
                          ' (95% Confidence Interval ', signif(ct$conf.int[[1]],2), 
                          ' to ', signif(ct$conf.int[[2]],2), ')')) +
  geom_smooth(method = 'lm',  color='purple')+
  labs(x = 'Proportion under 5', y = 'Proportion sought care',
       size = NULL, shape = NULL) +
  ggtitle('Care seeking at hospital/clinic by age distribution')
```

<br>

##### By case definition

```{r, fig.width = 7}
# plot relationship between prop under 5 and care seeking by case definition category
ggplot(df_cor, aes(y=prop_seek, x = prop_five)) +
  geom_point(alpha = 0.6, aes(size = n_did_survey)) +
  theme_bw() +
  theme(legend.position = 'bottom') +
  geom_smooth(method = 'lm',  color='purple')+
  labs(x = 'Proportion under 5', y = 'Proportion sought care',
       size = NULL, shape = NULL) +
  facet_wrap('case_cat') +
  ggtitle('Care seeking at hospital/clinic by age and case definition')
```

<br>

##### By income group

```{r, fig.width = 8}
# plot relationship between prop under 5 and care seeking by income category
ggplot(df_cor, aes(y=prop_seek, x = prop_five)) +
  geom_point(alpha = 0.6, aes(size = n_did_survey)) +
  theme_bw() +
  theme(legend.position = 'bottom') +
  geom_smooth(method = 'lm',  color='purple')+
  labs(x = 'Proportion under 5', y = 'Proportion sought care at hospital/clinic',
       size = NULL, shape = NULL) +
  facet_wrap('income_group', nrow = 1) +
  ggtitle('Care seeking at hospital/clinic by age and country income')
```

<br>

##### By case definition and income group

```{r, fig.width = 8, fig.height = 9}
# plot relationship between prop under 5 and care seeking by case definition and income category
ggplot(df_cor, aes(y=prop_seek, x = prop_five)) +
  geom_point(alpha = 0.6, aes(size = n_did_survey)) +
  theme_bw() +
  theme(legend.position = 'bottom') +
  geom_smooth(method = 'lm',  color='purple')+
  labs(x = 'Proportion under 5', y = 'Proportion sought care at hospital/clinic',
       size = NULL, shape = NULL) +
  facet_grid(income_group ~ case_cat) +
  ggtitle('Care seeking at hospital/clinic by age, income, and case definition')
```

<br>

#### Studies with either only kids or only adults

```{r}
f2age <- plot_seekprop(df_age %>% filter(prop_five == 0 | prop_five == 1), 'prop_five', num_colors=2) +
  ggtitle('Children (1) or adults (0)')

# df_age %>% filter(hic==0) %>%
#   filter(prop_five == 0 | prop_five == 1) %>%
#   group_by(prop_five) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r, fig.width = 3, fig.height = 3}
cowplot::plot_grid(f2age)
```

```{r, fig.width = 7, fig.height = 3}
cowplot::plot_grid(f2age + facet_wrap('case_cat'))
```

<br>

## Meta-analysis for LMICs

Our goal is to estimate the proportion of individuals that seek care when they or their child have diarrhea symptoms in LMICs. Since diarrhea symptoms vary, and some of the categories above had very few observations (e.g., cholera and "other") we have grouped these into three broad categories of case definitions (below). We'll start by testing these along with other potential covariates in univariate analyses.

i.  Diarrhea (3+ loose stools in past 24 hours OR general/no explicit definition provided)
ii. Cholera (acute watery diarrhea of any severity, including resulting in death) or severe diarrhea (danger signs, dehydration, hospitalization, 1+ week duration, or death)
iii. Gastroenteritis or other etiologies (diarrhea or vomiting, including specific etiologies eg rotavirus or e coli)

We'll build generalized linear models with a study-level random intercept following the approach of Wiens *et al* (2023) *PLOS Medicine*:

1.  Unadjusted

2.  Univariate models adjusted individually for:

    a.  Study methodology and population:
        -   case definition
        -   timing of care seeking
        -   regarding self or child
        -   recall period
        -   multiple choice questions
        -   study population
    b.  Contextual factors:
        -   outbreak
        -   urban/rural

3.  Multivatiate model(s) adjusted for factors identified as significant but not confounding/collinear in univariate models.

*NB*: Here our observations represent data aggregated to study_id, country, and potential covariate stratifications, for a total of 171 unique observations corresponding to 136 studies. For studies with multiple choice questions, we take the maximum sample size and number seeking care for studies where there were multiple categories of "hospital/clinic" as possible answers.

```{r prep for Stan}
# use all cores but 2
pacman::p_load('cmdstanr', 'parallel')
options(mc.cores = parallel::detectCores() - 2)

# Stan settings
stan_redo <- FALSE # set this to TRUE to re-run the stan_run_id corresponding to the stan_model and draws
sa <- FALSE # whether or not to run sensitivity analysis
test <- FALSE # add a 'test' flag to run_id 

# model script
if (!sa) {
  model_script <- here::here('code', 'meta_analysis_re.stan')
} 

# coefficient equations corresponding to each model
stan_mod_eqns <- list(
  'mod1' = '1',
  'mod2' = 'time_care + case_cat',
  'mod3' = 'time_care'
)
```

```{r prep data for Stan}
# set covariates
covs <- c('time_care', 'recall_time', 'pop_cat', 'mult_choice', 'self_or_child', # adjust for these
          'case_cat', 'outbreak_desc', 'location_desc') # examine differences by these (and age categories in separate analysis)

# proportion seeking care from meta-analysis primary dataset
# aggregate across stratifications that we're not including as covariates or stratifications
sr_dat <- df %>%
  # filter out high-income countries
  filter(hic == 0) %>%
  # filter to hospital/clinic (not private) and diarrhea (general)
  filter(location_type %in% c('Hospital/Clinic', 'Public Hospital/Clinic')) %>%
  # aggregate care seeking to entry_id, accounting for multiple choice questions
  group_by_at(c('entry_id', 'study_id', 'country_iso3', 'region', 'hic', 'income_group', covs)) %>%
  summarize(n_did_survey = n_did_survey,
            n_did = ifelse(mult_choice == 0, sum(n_did), max(n_did))) %>%
  ungroup() %>%
  unique() %>%
  # format variables, combining some to reduce combinations
  mutate(pop_cat = ifelse(pop_cat %in% c('Child with malnutrition', 'Orphan', 'Relative/Caregiver (of adult)',
                                         'Street dweller', 'University student', 'Other',
                                         'Resident', 'Resident with telephone/email access'), 'Other resident', pop_cat),
         location_desc = ifelse(location_desc == 'Urban', 'Urban',
                                ifelse(location_desc %in% c('Rural', 'Peri-Urban', 'IDP or Refugee Camp'), 'Non-urban', 
                                       'Urban and non-urban')),
         recall_time = ifelse(recall_time <= 30, 'under30', 'over30_orNA'),
         recall_time = ifelse(is.na(recall_time), 'over30_orNA', recall_time)) %>%
  # aggregate care seeking numbers to study_id and covariate categories ("observations")
  group_by_at(c('study_id', 'country_iso3', 'region', 'hic', 'income_group', covs)) %>%
  summarize(n_did_survey = sum(n_did_survey), 
            n_did = sum(n_did)) %>%
  ungroup() %>%
  unique() %>%
  mutate(propseek = n_did/n_did_survey)

# subset input data to diarrhea case definition
#stan_dat <- sr_dat %>% filter(case_cat == 'Diarrhea')
stan_dat <- sr_dat
case_strat <- 'all'

# add random effect label by observation
stan_dat <- stan_dat %>% mutate(study_lab = 1:nrow(stan_dat))

# create a template table of all covariates and reference categories (for use when building tables later)
cov_cats <- sr_dat %>% select_at(covs) %>%
  mutate(mult_choice = as.character(mult_choice),
         outbreak_desc = as.character(outbreak_desc)) %>%
  pivot_longer(covs, names_to = 'Variable', values_to = 'Category') %>%
  unique() %>% 
  arrange(Variable, Category) %>%
  mutate(Reference = ifelse(duplicated(Variable), 0, 1))
```

### Prior predictive checks

```{r run prior predictive checks for model 1}

# which Stan model to run
stan_model <- 'mod1' 
stan_coef_eqn <- stan_mod_eqns[[stan_model]]

# set model id to include in filename
stan_run_id <- paste0(case_strat, '-', stan_model, 
                      '-priorcheck',
                      ifelse(sa, '-sa', ''),
                      ifelse(test, '-test', ''))

# file to save to
out_est_file <- here::here('data', 'generated_data', 'prior_pred_checks',
                           paste0('propseek-', stan_run_id, '.rds'))

if (!file.exists(out_est_file) | stan_redo) {
  seekrate <- run_prior_checks(
    model_script = here::here('code', 'prior_pred_checks.stan'),
    dat_surveyed = stan_dat$n_did_survey,
    dat_covars = stan_dat %>% select_at(covs),
    re_ids = stan_dat$study_lab,
    run_id = stan_run_id,
    coef_eqn = stan_coef_eqn,
    redo = stan_redo
  )

  saveRDS(seekrate, out_est_file)
  
  # check model convergence and other diagnostics
  stan_out_file <- here::here("data", "generated_data", "prior_pred_checks", 
                              paste0("stan_fit_", stan_run_id,".rds"))
  stan_est <- readRDS(stan_out_file)
  stan_est$cmdstan_diagnose()
  #shinystan::launch_shinystan(stan_est)

} else {
  seekrate <- readRDS(out_est_file)
}
```

```{r plot prior checks, fig.width = 8, fig.height = 3}
# distributions of alpha
priorcheck1_file <- here::here('data', 'generated_data', 'prior_pred_checks', 'propseek-all-mod1-priorcheck.rds')
priorcheck1 <- readRDS(priorcheck1_file)

# proportion that sought care
prop_priorcheck1 <- stratify('mod1', 'all', data.frame(alpha = 1, n = 1, prop = 1), stan_mod_eqns,
                             draws_file = priorcheck1_file)[[1]]

# prior and posteriors
pal <- brewer.pal(11, 'PRGn')
s3aL <- plot_prior_post(priorcheck1$alpha$alpha, 
                'logit(global intercept)',
                arg1=0, arg2=2, dprior='dnorm') +
  ggtitle('Unadjusted') +
  scale_color_manual(values = c(pal[9], pal[2]), 
                     name = NULL, labels = c('Prior', 'Prior sampled'))

s3aR <- ggplot() +
  geom_histogram(aes(prop_priorcheck1$pos))+
  xlim(c(0,1)) +
  theme_classic() +
  ggtitle('Prior predictive distribution') +
  xlab('Proportion that sought care')

# plot
cowplot::plot_grid(s3aL, s3aR,
                   #s3bL, s3bR,
                   #s3cL, s3cR,
                   labels = c('A', ''), ncol = 2)
```

<br>

### Unadjusted estimates {.tabset}

```{r run unadjusted Stan models}

# run model 1 ----------------------------------------------------------

# which Stan model to run
stan_model <- 'mod1' 
stan_coef_eqn <- stan_mod_eqns[[stan_model]]

# set model id to include in filename
stan_run_id <- paste0(case_strat, '-', stan_model,
                      ifelse(sa, '-sa', ''),
                      ifelse(test, '-test', ''))

# file to save to
out_est_file <- here::here('data', 'generated_data', 'care_seeking_estimates',
                           paste0('propseek-', stan_run_id, '.rds'))

if (!file.exists(out_est_file) | stan_redo) {
  seekrate <- run_analysis_stan(
    model_script = model_script,
    dat_surveyed = stan_dat$n_did_survey,
    dat_soughtcare = stan_dat$n_did,
    dat_covars = stan_dat %>% select_at(covs),
    re_ids = stan_dat$study_lab,
    run_id = stan_run_id,
    coef_eqn = stan_coef_eqn,
    redo = stan_redo
  )

  saveRDS(seekrate, out_est_file)
  
  # check model convergence and other diagnostics
  stan_out_file <- here::here("data", "generated_data", "model_fits", 
                              paste0("stan_fit_", stan_run_id,".rds"))
  stan_est <- readRDS(stan_out_file)
  stan_est$cmdstan_diagnose()
  #shinystan::launch_shinystan(stan_est)

} else {
  seekrate <- readRDS(out_est_file)
}
```

```{r run univariate Stan models}

# loop over covariates
for (i in 1:length(covs)) {
  
  stan_model <- paste0('uni-', covs[[i]])
  stan_coef_eqn <- covs[[i]]

  # set model id to include in filename
  stan_run_id <- paste0(case_strat, '-', stan_model,
                        ifelse(sa, '-sa', ''),
                        ifelse(test, '-test', ''))
  
  # file to save to
  out_est_file <- here::here('data', 'generated_data', 'care_seeking_estimates',
                             paste0('propseek-', stan_run_id, '.rds'))
  
  if (!file.exists(out_est_file) | stan_redo) {
    print(paste0('Running univariate model for: ', covs[[i]]))
    
    seekrate <- run_analysis_stan(
      model_script = model_script,
      dat_surveyed = stan_dat$n_did_survey,
      dat_soughtcare = stan_dat$n_did,
      dat_covars = stan_dat %>% select_at(covs[[i]]),
      re_ids = stan_dat$study_lab,
      run_id = stan_run_id,
      coef_eqn = stan_coef_eqn,
      redo = stan_redo
    )
  
    saveRDS(seekrate, out_est_file)
    
    # check model convergence and other diagnostics
    stan_out_file <- here::here("data", "generated_data", "model_fits", 
                                paste0("stan_fit_", stan_run_id,".rds"))
    stan_est <- readRDS(stan_out_file)
    stan_est$cmdstan_diagnose()
    #shinystan::launch_shinystan(stan_est)
  
  } else {
    seekrate <- readRDS(out_est_file)
  }
}

```

```{r test for confounding with self_or_child}

# data to just adult vs. child
stan_dat_ac <- stan_dat %>% filter(self_or_child != 'Other')

# loop over covariates
for (cov in c('case_cat', 'time_care', 'outbreak_desc', 'recall_time', 'mult_choice')) {
  
  stan_model <- paste0('self_or_child-', cov)
  stan_coef_eqn <- cov

  # set model id to include in filename
  stan_run_id <- paste0(case_strat, '-', stan_model,
                        ifelse(sa, '-sa', ''),
                        ifelse(test, '-test', ''))
  
  # file to save to
  out_est_file <- here::here('data', 'generated_data', 'care_seeking_estimates',
                             paste0('propseek-', stan_run_id, '.rds'))
  
  if (!file.exists(out_est_file) | stan_redo) {
    print(paste0('Testing for confounding of self_or_child with: ', cov))
    
    seekrate <- run_analysis_stan(
      model_script = model_script,
      dat_surveyed = stan_dat_ac$n_did_survey,
      dat_soughtcare = ifelse(stan_dat_ac$self_or_child == 'Child', 0, 1),
      dat_covars = stan_dat_ac %>% select_at(cov),
      re_ids = stan_dat_ac$study_lab,
      run_id = stan_run_id,
      coef_eqn = stan_coef_eqn,
      redo = stan_redo
    )
  
    saveRDS(seekrate, out_est_file)
    
    # check model convergence and other diagnostics
    stan_out_file <- here::here("data", "generated_data", "model_fits", 
                                paste0("stan_fit_", stan_run_id,".rds"))
    stan_est <- readRDS(stan_out_file)
    stan_est$cmdstan_diagnose()
    #shinystan::launch_shinystan(stan_est)
  
  } else {
    seekrate <- readRDS(out_est_file)
  }
}
```

```{r test for confounding with outbreak_desc}

# loop over covariates
for (cov in c('case_cat', 'time_care', 'recall_time', 'self_or_child', 'mult_choice')) {
  
  stan_model <- paste0('outbreak_desc-', cov)
  stan_coef_eqn <- cov

  # set model id to include in filename
  stan_run_id <- paste0(case_strat, '-', stan_model,
                        ifelse(sa, '-sa', ''),
                        ifelse(test, '-test', ''))
  
  # file to save to
  out_est_file <- here::here('data', 'generated_data', 'care_seeking_estimates',
                             paste0('propseek-', stan_run_id, '.rds'))
  
  if (!file.exists(out_est_file) | stan_redo) {
    print(paste0('Testing for confounding of outbreak_desc with: ', cov))
    
    seekrate <- run_analysis_stan(
      model_script = model_script,
      dat_surveyed = stan_dat$n_did_survey,
      dat_soughtcare = stan_dat$outbreak_desc,
      dat_covars = stan_dat %>% select_at(cov),
      re_ids = stan_dat$study_lab,
      run_id = stan_run_id,
      coef_eqn = stan_coef_eqn,
      redo = stan_redo
    )
  
    saveRDS(seekrate, out_est_file)
    
    # check model convergence and other diagnostics
    stan_out_file <- here::here("data", "generated_data", "model_fits", 
                                paste0("stan_fit_", stan_run_id,".rds"))
    stan_est <- readRDS(stan_out_file)
    stan_est$cmdstan_diagnose()
    #shinystan::launch_shinystan(stan_est)
  
  } else {
    seekrate <- readRDS(out_est_file)
  }
}
```

```{r test for confounding with case_cat}

# data to just look at either diarrhea and 1) vc or severe, or 2) gastro or non-vc
stan_dat_vc <- stan_dat %>% filter(case_cat != 'Gastroenteritis or non-Vc etiologies')
stan_dat_ge <- stan_dat %>% filter(case_cat != 'Severe diarrhea or cholera')

# loop over covariates for Severe diarrhea or cholera  -------------------------------
for (cov in c('outbreak_desc', 'time_care', 'recall_time', 'self_or_child', 'mult_choice')) {
  
  stan_model <- paste0('vc_severe-', cov)
  stan_coef_eqn <- cov

  # set model id to include in filename
  stan_run_id <- paste0(case_strat, '-', stan_model,
                        ifelse(sa, '-sa', ''),
                        ifelse(test, '-test', ''))
  
  # file to save to
  out_est_file <- here::here('data', 'generated_data', 'care_seeking_estimates',
                             paste0('propseek-', stan_run_id, '.rds'))
  
  if (!file.exists(out_est_file) | stan_redo) {
    print(paste0('Testing for confounding of vc_severe with: ', cov))
    
    seekrate <- run_analysis_stan(
      model_script = model_script,
      dat_surveyed = stan_dat_vc$n_did_survey,
      dat_soughtcare = ifelse(stan_dat_vc$case_cat == 'Diarrhea', 0, 1),
      dat_covars = stan_dat_vc %>% select_at(cov),
      re_ids = stan_dat_vc$study_lab,
      run_id = stan_run_id,
      coef_eqn = stan_coef_eqn,
      redo = stan_redo
    )
  
    saveRDS(seekrate, out_est_file)
    
    # check model convergence and other diagnostics
    stan_out_file <- here::here("data", "generated_data", "model_fits", 
                                paste0("stan_fit_", stan_run_id,".rds"))
    stan_est <- readRDS(stan_out_file)
    stan_est$cmdstan_diagnose()
    #shinystan::launch_shinystan(stan_est)
  
  } else {
    seekrate <- readRDS(out_est_file)
  }
}

# loop over covariates for Gastroenteritis or non-Vc etiologies -----------------------
for (cov in c('outbreak_desc', 'time_care', 'recall_time', 'self_or_child', 'mult_choice')) {
  
  stan_model <- paste0('ge_nonvc-', cov)
  stan_coef_eqn <- cov

  # set model id to include in filename
  stan_run_id <- paste0(case_strat, '-', stan_model,
                        ifelse(sa, '-sa', ''),
                        ifelse(test, '-test', ''))
  
  # file to save to
  out_est_file <- here::here('data', 'generated_data', 'care_seeking_estimates',
                             paste0('propseek-', stan_run_id, '.rds'))
  
  if (!file.exists(out_est_file) | stan_redo) {
    print(paste0('Testing for confounding of ge_nonvc with: ', cov))
    
    seekrate <- run_analysis_stan(
      model_script = model_script,
      dat_surveyed = stan_dat_ge$n_did_survey,
      dat_soughtcare = ifelse(stan_dat_ge$case_cat == 'Diarrhea', 0, 1),
      dat_covars = stan_dat_ge %>% select_at(cov),
      re_ids = stan_dat_ge$study_lab,
      run_id = stan_run_id,
      coef_eqn = stan_coef_eqn,
      redo = stan_redo
    )
  
    saveRDS(seekrate, out_est_file)
    
    # check model convergence and other diagnostics
    stan_out_file <- here::here("data", "generated_data", "model_fits", 
                                paste0("stan_fit_", stan_run_id,".rds"))
    stan_est <- readRDS(stan_out_file)
    stan_est$cmdstan_diagnose()
    #shinystan::launch_shinystan(stan_est)
  
  } else {
    seekrate <- readRDS(out_est_file)
  }
}
```

```{r run multivariate Stan models}
# run model 2 ----------------------------------------------------------

# which Stan model to run
stan_model <- 'mod2' 
stan_coef_eqn <- stan_mod_eqns[[stan_model]]

# set model id to include in filename
stan_run_id <- paste0(case_strat, '-', stan_model,
                      ifelse(sa, '-sa', ''),
                      ifelse(test, '-test', ''))

# file to save to
out_est_file <- here::here('data', 'generated_data', 'care_seeking_estimates',
                           paste0('propseek-', stan_run_id, '.rds'))

if (!file.exists(out_est_file) | stan_redo) {
  seekrate <- run_analysis_stan(
    model_script = model_script,
    dat_surveyed = stan_dat$n_did_survey,
    dat_soughtcare = stan_dat$n_did,
    dat_covars = stan_dat %>% select_at(covs),
    re_ids = stan_dat$study_lab,
    run_id = stan_run_id,
    coef_eqn = stan_coef_eqn,
    redo = stan_redo
  )

  saveRDS(seekrate, out_est_file)
  
  # check model convergence and other diagnostics
  stan_out_file <- here::here("data", "generated_data", "model_fits", 
                              paste0("stan_fit_", stan_run_id,".rds"))
  stan_est <- readRDS(stan_out_file)
  stan_est$cmdstan_diagnose()
  #shinystan::launch_shinystan(stan_est)

} else {
  seekrate <- readRDS(out_est_file)
}


# run model 3 ----------------------------------------------------------

# which Stan model to run
stan_model <- 'mod3' 
stan_coef_eqn <- stan_mod_eqns[[stan_model]]

# set model id to include in filename
stan_run_id <- paste0(case_strat, '-', stan_model,
                      ifelse(sa, '-sa', ''),
                      ifelse(test, '-test', ''))

# file to save to
out_est_file <- here::here('data', 'generated_data', 'care_seeking_estimates',
                           paste0('propseek-', stan_run_id, '.rds'))

if (!file.exists(out_est_file) | stan_redo) {
  seekrate <- run_analysis_stan(
    model_script = model_script,
    dat_surveyed = stan_dat$n_did_survey,
    dat_soughtcare = stan_dat$n_did,
    dat_covars = stan_dat %>% select_at(covs),
    re_ids = stan_dat$study_lab,
    run_id = stan_run_id,
    coef_eqn = stan_coef_eqn,
    redo = stan_redo
  )

  saveRDS(seekrate, out_est_file)
  
  # check model convergence and other diagnostics
  stan_out_file <- here::here("data", "generated_data", "model_fits", 
                              paste0("stan_fit_", stan_run_id,".rds"))
  stan_est <- readRDS(stan_out_file)
  stan_est$cmdstan_diagnose()
  #shinystan::launch_shinystan(stan_est)

} else {
  seekrate <- readRDS(out_est_file)
}

```

```{r run sensitivity analyses with priors shifted for models 1-3}

for (prior in c('L', 'R')) {
  
  # model script for sensitivity analyses with priors shifted left or right
  model_script <- here::here('code', paste0('meta_analysis_re_sa', prior, '.stan'))
  
  # model 1 --------------------------------------------------------------------
  stan_model <- 'mod1' 
  stan_coef_eqn <- stan_mod_eqns[[stan_model]]
  
  # set model id to include in filename
  stan_run_id <- paste0(case_strat, '-', stan_model,
                        '-sa', prior,
                        ifelse(test, '-test', ''))
  
  # file to save to
  out_est_file <- here::here('data', 'generated_data', 'care_seeking_estimates',
                             paste0('propseek-', stan_run_id, '.rds'))
  
  if (!file.exists(out_est_file) | stan_redo) {
    seekrate <- run_analysis_stan(
      model_script = model_script,
      dat_surveyed = stan_dat$n_did_survey,
      dat_soughtcare = stan_dat$n_did,
      dat_covars = stan_dat %>% select_at(covs),
      re_ids = stan_dat$study_lab,
      run_id = stan_run_id,
      coef_eqn = stan_coef_eqn,
      redo = stan_redo
    )
  
    saveRDS(seekrate, out_est_file)
    
    # check model convergence and other diagnostics
    stan_out_file <- here::here("data", "generated_data", "model_fits", 
                                paste0("stan_fit_", stan_run_id,".rds"))
    stan_est <- readRDS(stan_out_file)
    stan_est$cmdstan_diagnose()
    #shinystan::launch_shinystan(stan_est)
  
  } else {
    seekrate <- readRDS(out_est_file)
  }
  
  # model 2 --------------------------------------------------------------------
  stan_model <- 'mod2' 
  stan_coef_eqn <- stan_mod_eqns[[stan_model]]
  
  # set model id to include in filename
  stan_run_id <- paste0(case_strat, '-', stan_model,
                        '-sa', prior,
                        ifelse(test, '-test', ''))
  
  # file to save to
  out_est_file <- here::here('data', 'generated_data', 'care_seeking_estimates',
                             paste0('propseek-', stan_run_id, '.rds'))
  
  if (!file.exists(out_est_file) | stan_redo) {
    seekrate <- run_analysis_stan(
      model_script = model_script,
      dat_surveyed = stan_dat$n_did_survey,
      dat_soughtcare = stan_dat$n_did,
      dat_covars = stan_dat %>% select_at(covs),
      re_ids = stan_dat$study_lab,
      run_id = stan_run_id,
      coef_eqn = stan_coef_eqn,
      redo = stan_redo
    )
  
    saveRDS(seekrate, out_est_file)
    
    # check model convergence and other diagnostics
    stan_out_file <- here::here("data", "generated_data", "model_fits", 
                                paste0("stan_fit_", stan_run_id,".rds"))
    stan_est <- readRDS(stan_out_file)
    stan_est$cmdstan_diagnose()
    #shinystan::launch_shinystan(stan_est)
  
  } else {
    seekrate <- readRDS(out_est_file)
  }
  
  
  # model 3 --------------------------------------------------------------------
  stan_model <- 'mod3' 
  stan_coef_eqn <- stan_mod_eqns[[stan_model]]
  
  # set model id to include in filename
  stan_run_id <- paste0(case_strat, '-', stan_model,
                        '-sa', prior,
                        ifelse(test, '-test', ''))
  
  # file to save to
  out_est_file <- here::here('data', 'generated_data', 'care_seeking_estimates',
                             paste0('propseek-', stan_run_id, '.rds'))
  
  if (!file.exists(out_est_file) | stan_redo) {
    seekrate <- run_analysis_stan(
      model_script = model_script,
      dat_surveyed = stan_dat$n_did_survey,
      dat_soughtcare = stan_dat$n_did,
      dat_covars = stan_dat %>% select_at(covs),
      re_ids = stan_dat$study_lab,
      run_id = stan_run_id,
      coef_eqn = stan_coef_eqn,
      redo = stan_redo
    )
  
    saveRDS(seekrate, out_est_file)
    
    # check model convergence and other diagnostics
    stan_out_file <- here::here("data", "generated_data", "model_fits", 
                                paste0("stan_fit_", stan_run_id,".rds"))
    stan_est <- readRDS(stan_out_file)
    stan_est$cmdstan_diagnose()
    #shinystan::launch_shinystan(stan_est)
  
  } else {
    seekrate <- readRDS(out_est_file)
  }
  
}


```

```{r run cholera model to test effect of outbreaks}

# which Stan model to run
case_strat <- 'vc'
stan_model <- 'uni-outbreak_desc'
stan_coef_eqn <- 'outbreak_desc'

# subset to case_strat
stan_dat_vconly <- stan_dat %>% filter(case_cat == 'Severe diarrhea or cholera')

# set model id to include in filename
stan_run_id <- paste0(case_strat, '-', stan_model,
                      ifelse(sa, '-sa', ''),
                      ifelse(test, '-test', ''))

# file to save to
out_est_file <- here::here('data', 'generated_data', 'care_seeking_estimates',
                           paste0('propseek-', stan_run_id, '.rds'))

if (!file.exists(out_est_file) | stan_redo) {
  seekrate <- run_analysis_stan(
    model_script = model_script,
    dat_surveyed = stan_dat_vconly$n_did_survey,
    dat_soughtcare = stan_dat_vconly$n_did,
    dat_covars = stan_dat_vconly %>% select_at(covs),
    re_ids = stan_dat_vconly$study_lab,
    run_id = stan_run_id,
    coef_eqn = stan_coef_eqn,
    redo = stan_redo
  )

  saveRDS(seekrate, out_est_file)
  
  # check model convergence and other diagnostics
  stan_out_file <- here::here("data", "generated_data", "model_fits", 
                              paste0("stan_fit_", stan_run_id,".rds"))
  stan_est <- readRDS(stan_out_file)
  stan_est$cmdstan_diagnose()
  #shinystan::launch_shinystan(stan_est)

} else {
  seekrate <- readRDS(out_est_file)
}
```

```{r run diarrhea model to test effect of recall period}

# which Stan model to run
case_strat <- 'dia'
stan_model <- 'uni-recall_time'
stan_coef_eqn <- 'recall_time'

# subset to case_strat
stan_dat_dia <- stan_dat %>% filter(case_cat == 'Diarrhea')

# set model id to include in filename
stan_run_id <- paste0(case_strat, '-', stan_model,
                      ifelse(sa, '-sa', ''),
                      ifelse(test, '-test', ''))

# file to save to
out_est_file <- here::here('data', 'generated_data', 'care_seeking_estimates',
                           paste0('propseek-', stan_run_id, '.rds'))

if (!file.exists(out_est_file) | stan_redo) {
  seekrate <- run_analysis_stan(
    model_script = model_script,
    dat_surveyed = stan_dat_dia$n_did_survey,
    dat_soughtcare = stan_dat_dia$n_did,
    dat_covars = stan_dat_dia %>% select_at(covs),
    re_ids = stan_dat_dia$study_lab,
    run_id = stan_run_id,
    coef_eqn = stan_coef_eqn,
    redo = stan_redo
  )

  saveRDS(seekrate, out_est_file)
  
  # check model convergence and other diagnostics
  stan_out_file <- here::here("data", "generated_data", "model_fits", 
                              paste0("stan_fit_", stan_run_id,".rds"))
  stan_est <- readRDS(stan_out_file)
  stan_est$cmdstan_diagnose()
  #shinystan::launch_shinystan(stan_est)

} else {
  seekrate <- readRDS(out_est_file)
}
```

```{r sub-analysis by age 1}
# subset data
#NB: still don't find significant differences when subset by case definition, although the etiologies approach significance
df_meta1 <- df_age %>% 
  filter(prop_five == 0 | prop_five == 1) %>%
  filter(hic == 0) %>%
  arrange(prop_seek)

# add random effect variable
df_meta1 <- df_meta1 %>% mutate(study_lab = 1:nrow(df_meta1))

# which Stan model to run
stan_model <- 'all_age' 
stan_coef_eqn <- 'prop_five'
case_strat <- 'all'
stan_redo <- FALSE
model_script <- here::here('code', 'meta_analysis_re.stan')

# set model id to include in filename
stan_run_id <- paste0(case_strat, '-', stan_model)

# file to save to
out_est_file <- here::here('data', 'generated_data', 'care_seeking_estimates',
                           paste0('propseek-', stan_run_id, '.rds'))

if (!file.exists(out_est_file) | stan_redo) {
  seekrate <- run_analysis_stan(
    model_script = model_script,
    dat_surveyed = df_meta1$n_did_survey,
    dat_soughtcare = df_meta1$n_did,
    dat_covars = df_meta1 %>% select(prop_five),
    re_ids = df_meta1$study_lab,
    run_id = stan_run_id,
    coef_eqn = stan_coef_eqn,
    redo = stan_redo
  )

  saveRDS(seekrate, out_est_file)
  
  # check model convergence and other diagnostics
  stan_out_file <- here::here("data", "generated_data", "model_fits", 
                              paste0("stan_fit_", stan_run_id,".rds"))
  stan_est <- readRDS(stan_out_file)
  stan_est$cmdstan_diagnose()
  #shinystan::launch_shinystan(stan_est)

} else {
  seekrate <- readRDS(out_est_file)
}
```

```{r sub-analysis by age 2}
# prep data
df_age_strat <- df_age %>%
  filter(strat_age == 1) %>%
  filter(hic == 0) %>%
  group_by_at('study_id') %>%
  mutate(n_strats = n()) %>%
  ungroup() %>%
  filter(n_strats > 1) %>%
  # remove the study the looks only at 0-15 and 16-44
  filter(study_id != 49) %>%
  # aggregate by under/over five
  group_by_at(c('study_id', 'country_iso3', 'region', 'hic', 'income_group', 
                'recall_time', 'case_cat', 'prop_five')) %>%
  summarize(n_did_survey = sum(n_did_survey), 
            n_did = sum(n_did)) %>%
  ungroup() %>%
  unique() %>%
  # proportion seeking care
  mutate(prop_seek = n_did/n_did_survey)

# subset data
df_meta2 <- df_age_strat %>% 
  arrange(prop_seek)

# add random effect variable
df_meta2 <- df_meta2 %>% mutate(study_lab = 1:nrow(df_meta2))

# which Stan model to run
stan_model <- 'match_age' 
stan_coef_eqn <- 'prop_five'
case_strat <- 'all'
stan_redo <- FALSE
model_script <- here::here('code', 'meta_analysis_re.stan')

# set model id to include in filename
stan_run_id <- paste0(case_strat, '-', stan_model)

# file to save to
out_est_file <- here::here('data', 'generated_data', 'care_seeking_estimates',
                           paste0('propseek-', stan_run_id, '.rds'))

if (!file.exists(out_est_file) | stan_redo) {
  seekrate <- run_analysis_stan(
    model_script = model_script,
    dat_surveyed = df_meta2$n_did_survey,
    dat_soughtcare = df_meta2$n_did,
    dat_covars = df_meta2 %>% select(prop_five),
    re_ids = df_meta2$study_lab,
    run_id = stan_run_id,
    coef_eqn = stan_coef_eqn,
    redo = stan_redo
  )

  saveRDS(seekrate, out_est_file)
  
  # check model convergence and other diagnostics
  stan_out_file <- here::here("data", "generated_data", "model_fits", 
                              paste0("stan_fit_", stan_run_id,".rds"))
  stan_est <- readRDS(stan_out_file)
  stan_est$cmdstan_diagnose()
  #shinystan::launch_shinystan(stan_est)

} else {
  seekrate <- readRDS(out_est_file)
}
```

```{r data by covariate strata}
strata1_dat <- stan_dat %>%
  group_by(time_care, case_cat) %>%
  summarize(weighted_mean = round(weighted.mean(n_did/n_did_survey, n_did_survey, na.rm=TRUE)*100,1),
            median = round(median(n_did/n_did_survey)*100,1)) %>%
  ungroup() %>%
  arrange(time_care, case_cat)

strata2_dat <- stan_dat %>%
  group_by(time_care) %>%
  summarize(weighted_mean = round(weighted.mean(n_did/n_did_survey, n_did_survey, na.rm=TRUE)*100,1),
            median = round(median(n_did/n_did_survey)*100,1)) %>%
  ungroup() %>%
  arrange(time_care)
```

```{r combine model results}
mod_ests <- data.frame(run_id = NA,
                      stan_id = NA,
                      mean = NA,
                      lower = NA,
                      upper = NA,
                      row.names = NULL)

file_names <- list.files(here::here('data', 'generated_data', 'care_seeking_estimates'))
file_names <- file_names[grep('propseek-all|propseek-vc|propseek-dia', file_names)]

for (i in file_names) {
  
  propseek <- readRDS(here::here('data', 'generated_data', 'care_seeking_estimates', i))
  model_name <- gsub('propseek-|\\.rds', '', i)
  
  # save alpha results
  mod_ests <- rbind(mod_ests,
                   data.frame(run_id = model_name,
                              stan_id = 'alpha',
                              mean = mean(inv.logit(propseek$alpha$alpha), na.rm = T),
                              lower = quantile(inv.logit(propseek$alpha$alpha), probs = .025, na.rm = T),
                              upper = quantile(inv.logit(propseek$alpha$alpha), probs = .975, na.rm = T),
                              row.names = NULL
                              )
                   )
  
  # save beta coefficients
  for (c in names(propseek$beta)) {
    if (c != '(Intercept)') {
      mod_ests <- rbind(mod_ests,
                       data.frame(
                         run_id = model_name,
                         stan_id = c,
                         mean = mean(propseek[['beta']][[c]], na.rm = T),
                         lower = quantile(propseek[['beta']][[c]], probs = .025, na.rm = T),
                         upper = quantile(propseek[['beta']][[c]], probs = .975, na.rm = T),
                         row.names = NULL
                       )
      )
    }
  }
  
}

```

```{r stratify}

# get the proportion of studies by covariate categories
# note: the function integrates over RE, post-stratifies, and stratifies, 
#       which is why we pull these, but in the paper we only present stratified results 
#       because they are more meaningful

cats_mod2 <- obs_by_cat(stan_dat, c('time_care', 'case_cat'))
cats_mod3 <- obs_by_cat(stan_dat, c('time_care'))

# get overall care seeking proportion for unadjusted model, integrating over random effects
prop_mod1 <- stratify('mod1', 'all', data.frame(alpha = 1, n = 1, prop = 1), stan_mod_eqns)[[1]]
prop_mod1_saL <- stratify('mod1', sa = '-saL', 'all', data.frame(alpha = 1, n = 1, prop = 1), stan_mod_eqns)[[1]]
prop_mod1_saR <- stratify('mod1', sa = '-saR', 'all', data.frame(alpha = 1, n = 1, prop = 1), stan_mod_eqns)[[1]]

# post-stratify to get overall care seeking proportion by strata
prop_strat_mod2 <- stratify('mod2', 'all', cats_mod2, stan_mod_eqns)[[2]]
prop_strat_mod2_saL <- stratify('mod2', sa = '-saL', 'all', cats_mod2, stan_mod_eqns)[[2]]
prop_strat_mod2_saR <- stratify('mod2', sa = '-saR', 'all', cats_mod2, stan_mod_eqns)[[2]]

prop_strat_mod3 <- stratify('mod3', 'all', cats_mod3, stan_mod_eqns)[[2]]
prop_strat_mod3_saL <- stratify('mod3', sa = '-saL', 'all', cats_mod2, stan_mod_eqns)[[2]]
prop_strat_mod3_saR <- stratify('mod3', sa = '-saR', 'all', cats_mod2, stan_mod_eqns)[[2]]

# main results ----------------------------------------------------------------
# save unadjusted post-stratified proportion to mod_est data frame
mod_ests <- rbind(mod_ests,
                  data.frame(run_id = 'all-mod1',
                             stan_id = 'prop',
                             mean = mean(prop_mod1$pos, na.rm = T),
                             lower = quantile(prop_mod1$pos, probs = .025, na.rm = T),
                             upper = quantile(prop_mod1$pos, probs = .975, na.rm = T),
                             row.names = NULL
                             )
                  )

# stratifications below each correspond to:
#     time_care == 'Any care'
prop_mod2_sub <- prop_strat_mod2 %>%
  filter(`time_careFirst source` == 0 & `time_carePrior to current visit` == 0)

prop_mod3_sub <- prop_strat_mod3 %>%
  filter(`time_careFirst source` == 0 & `time_carePrior to current visit` == 0)

# save estimates for each case definition category
prop_mod2_sub <- prop_mod2_sub %>%
  select_at(names(prop_mod2_sub)[grep("mean|lower|upper|case_cat", names(prop_mod2_sub))])

case_cats <- names(prop_mod2_sub)[grep("case_cat", names(prop_mod2_sub))]
case_cats <- gsub('case_cat', '', case_cats)

mod_ests <- rbind(mod_ests,
                  data.frame(run_id = c('Diarrhea', case_cats),
                             stan_id = rep('prop', nrow(prop_mod2_sub)),
                             mean = prop_mod2_sub$mean,
                             lower = prop_mod2_sub$lower,
                             upper = prop_mod2_sub$upper,
                             row.names = NULL
                             )
                  )

# save estimates for methods-adjusted estimate
mod_ests <- rbind(mod_ests,
                  data.frame(run_id = 'Adjusted for methods',
                             stan_id = 'prop',
                             mean = prop_mod3_sub[, 'mean'],
                             lower = prop_mod3_sub[, 'lower'],
                             upper = prop_mod3_sub[, 'upper'],
                             row.names = NULL
                             )
                  )

# priors shifted left  --------------------------------------------------------
# save unadjusted post-stratified proportion to mod_est data frame
mod_ests <- rbind(mod_ests,
                  data.frame(run_id = 'all-mod1-saL',
                             stan_id = 'prop',
                             mean = mean(prop_mod1_saL$pos, na.rm = T),
                             lower = quantile(prop_mod1_saL$pos, probs = .025, na.rm = T),
                             upper = quantile(prop_mod1_saL$pos, probs = .975, na.rm = T),
                             row.names = NULL
                             )
                  )

# stratifications below each correspond to:
#     time_care == 'Any care'
prop_mod2_sub_saL <- prop_strat_mod2_saL %>%
  filter(`time_careFirst source` == 0 & `time_carePrior to current visit` == 0)

prop_mod3_sub_saL <- prop_strat_mod3_saL %>%
  filter(`time_careFirst source` == 0 & `time_carePrior to current visit` == 0)

# save estimates for each case definition category
prop_mod2_sub_saL <- prop_mod2_sub_saL %>%
  select_at(names(prop_mod2_sub_saL)[grep("mean|lower|upper|case_cat", names(prop_mod2_sub_saL))])

case_cats <- names(prop_mod2_sub_saL)[grep("case_cat", names(prop_mod2_sub_saL))]
case_cats <- gsub('case_cat', '', case_cats)

mod_ests <- rbind(mod_ests,
                  data.frame(run_id = paste0(c('Diarrhea', case_cats), ' (shift prior left)'),
                             stan_id = rep('prop', nrow(prop_mod2_sub_saL)),
                             mean = prop_mod2_sub_saL$mean,
                             lower = prop_mod2_sub_saL$lower,
                             upper = prop_mod2_sub_saL$upper,
                             row.names = NULL
                             )
                  )

# save estimates for methods-adjusted estimate
mod_ests <- rbind(mod_ests,
                  data.frame(run_id = 'Adjusted for methods (shift prior left)',
                             stan_id = 'prop',
                             mean = prop_mod3_sub_saL[, 'mean'],
                             lower = prop_mod3_sub_saL[, 'lower'],
                             upper = prop_mod3_sub_saL[, 'upper'],
                             row.names = NULL
                             )
                  )

# priors shifted right --------------------------------------------------------
# save unadjusted post-stratified proportion to mod_est data frame
mod_ests <- rbind(mod_ests,
                  data.frame(run_id = 'all-mod1-saR',
                             stan_id = 'prop',
                             mean = mean(prop_mod1_saR$pos, na.rm = T),
                             lower = quantile(prop_mod1_saR$pos, probs = .025, na.rm = T),
                             upper = quantile(prop_mod1_saR$pos, probs = .975, na.rm = T),
                             row.names = NULL
                             )
                  )

# stratifications below each correspond to:
#     time_care == 'Any care'
prop_mod2_sub_saR <- prop_strat_mod2_saR %>%
  filter(`time_careFirst source` == 0 & `time_carePrior to current visit` == 0)

prop_mod3_sub_saR <- prop_strat_mod3_saR %>%
  filter(`time_careFirst source` == 0 & `time_carePrior to current visit` == 0)

# save estimates for each case definition category
prop_mod2_sub_saR <- prop_mod2_sub_saR %>%
  select_at(names(prop_mod2_sub_saR)[grep("mean|lower|upper|case_cat", names(prop_mod2_sub_saR))])

case_cats <- names(prop_mod2_sub_saR)[grep("case_cat", names(prop_mod2_sub_saR))]
case_cats <- gsub('case_cat', '', case_cats)

mod_ests <- rbind(mod_ests,
                  data.frame(run_id = paste0(c('Diarrhea', case_cats), ' (shift prior right)'),
                             stan_id = rep('prop', nrow(prop_mod2_sub_saR)),
                             mean = prop_mod2_sub_saR$mean,
                             lower = prop_mod2_sub_saR$lower,
                             upper = prop_mod2_sub_saR$upper,
                             row.names = NULL
                             )
                  )

# save estimates for methods-adjusted estimate
mod_ests <- rbind(mod_ests,
                  data.frame(run_id = 'Adjusted for methods (shift prior right)',
                             stan_id = 'prop',
                             mean = prop_mod3_sub_saR[, 'mean'],
                             lower = prop_mod3_sub_saR[, 'lower'],
                             upper = prop_mod3_sub_saR[, 'upper'],
                             row.names = NULL
                             )
                  )

# --- tidy all results ---
mod_ests <- mod_ests %>%
  drop_na() %>%
  mutate(mean=ifelse(stan_id == 'prop', round(mean*100,1), mean),
         lower=ifelse(stan_id == 'prop', round(lower*100,1), lower),
         upper=ifelse(stan_id == 'prop', round(upper*100,1), upper))
```

#### Bayesian approach

##### Posterior distributions of the proportion of people seeking care

```{r figS4, fig.width=7, fig.height=9}
# distributions of alpha
propseek1 <- readRDS(here::here('data', 'generated_data', 'care_seeking_estimates', 'propseek-all-mod1.rds'))
propseek1_saL <- readRDS(here::here('data', 'generated_data', 'care_seeking_estimates', 'propseek-all-mod1-saL.rds'))
propseek1_saR <- readRDS(here::here('data', 'generated_data', 'care_seeking_estimates', 'propseek-all-mod1-saR.rds'))

# prior and posterios
s4aL <- plot_prior_post(propseek1$alpha$alpha, 
                'logit(global intercept)',
                arg1=0, arg2=2, dprior='dnorm') +
  ggtitle('Unadjusted')

s4bL <- plot_prior_post(propseek1_saL$alpha$alpha, 
                'logit(global intercept)',
                arg1=-0.9, arg2=2, dprior='dnorm') +
  ggtitle('Unadjusted - shift prior left')

s4cL <- plot_prior_post(propseek1_saR$alpha$alpha, 
                'logit(global intercept)',
                arg1=0.9, arg2=2, dprior='dnorm') +
  ggtitle('Unadjusted - shift prior right')


# distributions of the proportion seeking care
s4aR <- ggplot() +
  geom_histogram(aes(prop_mod1$pos))+
  xlim(c(0,1)) +
  theme_classic() +
  xlab('Proportion that sought care') + ggtitle('  ')

s4bR <- ggplot() +
  geom_histogram(aes(prop_mod1_saL$pos))+
  xlim(c(0,1)) +
  theme_classic() +
  xlab('Proportion that sought care') + ggtitle('  ')

s4cR <- ggplot() +
  geom_histogram(aes(prop_mod1_saR$pos))+
  xlim(c(0,1)) +
  theme_classic() +
  xlab('Proportion that sought care') + ggtitle('  ')

# plot
cowplot::plot_grid(s4aL, s4aR,
                   s4bL, s4bR,
                   s4cL, s4cR,
                   labels = c('A', '', 'B', '', 'C', ''), ncol = 2)
```

<br>

##### Estimated proportion that seek care

```{r tabS4}
# mean adjusted proportion seeking care
pr2 <- mod_ests %>%
  filter(run_id %in% c('all-mod1', 'all-mod1-saL', 'all-mod1-saR'), 
         stan_id == 'prop') %>%
  arrange(run_id) %>%
  dplyr::select(lower, mean, upper)

# table S4
tabS4 <- data.frame('Version' = c('Unadjusted', 
                                  'Unadjusted - shift prior left', 
                                  'Unadjusted - shift prior right'),
                    'Proportion' = paste0(pr2[,2],' (',pr2[,1],' - ',pr2[,3],')'))

names(tabS4) <- c('Version', 'Proportion (%)')
pretty_table(tabS4)

# tabS4 %>%
#   flextable() %>%
#   save_as_docx(path = here::here('code/tables/tableS4.docx'))
```

<br>

#### RE meta-anaysis a la 'meta'

```{r, fig.width = 8, fig.height = 31}

ma_nobayes <- metaprop(n_did, n_did_survey, data = arrange(sr_dat, propseek), 
                       studlab = paste0(sr_dat$study_id, '_', sr_dat$country_iso3), 
                       method = 'GLMM', common = FALSE)

ma_nobayes
forest(ma_nobayes)

```

<br>

### Sub-analyses by age

#### Studies that are either only adults or only children {.tabset}

##### Bayesian approach

Odds of seeking care for diarrhea for adults vs. children, not adjusting for any other variables. We have 130 observations total here.

```{r or children adults}
age_cats <- df_meta1 %>% dplyr::select(prop_five) %>%
  pivot_longer('prop_five', names_to = 'Variable', values_to = 'Category') %>%
  unique() %>% 
  arrange(Variable, Category) %>%
  mutate(Reference = ifelse(duplicated(Variable), 0, 1),
         Category = as.character(Category))

mod_ests_age1 <- mod_ests %>%
    filter(grepl('all-all_age', run_id) & stan_id != 'alpha') %>%
  or_table(cov_vector = 'prop_five', cov_cats_df = age_cats)

pretty_table(mod_ests_age1)
```

<br>

##### RE meta-analysis a la 'meta'

```{r, fig.width = 8, fig.height = 28}
# run meta-analysis with subgroup by age
ma_age1 <- metaprop(n_did, n_did_survey, data = df_meta1, 
                    subgroup = df_meta1$prop_five,
                    studlab = paste0(df_meta1$study_id, '_', df_meta1$country_iso3), 
                    method = 'GLMM', common = FALSE)

ma_age1
forest(ma_age1)
```

<br>

#### Studies with care seeking stratified by age {.tabset}

##### Bayesian approach

Odds of seeking care for diarrhea for adults vs. children, not adjusting for any other variables. We have data from 7 studies that report healthcare seeking at a hospital/clinic by age groups under/over five for LMICs.

```{r or children adults matched}
mod_ests_age2 <- mod_ests %>%
    filter(grepl('all-match_age', run_id) & stan_id != 'alpha') %>%
  or_table(cov_vector = 'prop_five', cov_cats_df = age_cats)

pretty_table(mod_ests_age2)
```

<br>

##### RE meta-analysis a la 'meta'

```{r, fig.width = 8, fig.height = 7}
# run meta-analysis with subgroup by age
ma_age2 <- metaprop(n_did, n_did_survey, data = df_meta2, 
                    subgroup = df_meta2$prop_five,
                    studlab = paste0(df_meta2$study_id, '_', df_meta2$country_iso3), 
                    method = 'GLMM', common = FALSE)

ma_age2
forest(ma_age2)
```

<br>

### Univariate analyses

Odds of seeking care for diarrhea for each indicated variable, not adjusting for any other variables.

```{r univariate odds ratios}
mod_ests_uni <- mod_ests %>%
    filter(grepl('all-uni', run_id) & stan_id != 'alpha') %>%
  or_table()

pretty_table(mod_ests_uni)
```

<br>

### Tests for potential confounding {.tabset}

In analyses below, the dependent variable is listed in the header.

#### self_or_child (adult vs child)

```{r self_or_child confounding}
mod_ests_soc <- mod_ests %>%
    filter(grepl('all-self_or_child', run_id) & stan_id != 'alpha') %>%
  or_table()

pretty_table(mod_ests_soc)
```

<br>

#### outbreak_desc

```{r outbreak_desc confounding}
mod_ests_out <- mod_ests %>%
    filter(grepl('all-outbreak_desc', run_id) & stan_id != 'alpha') %>%
  or_table()

pretty_table(mod_ests_out)
```

<br>

#### case_cat

##### Severe diarrhea or cholera

```{r vc_severe confounding}
mod_ests_vc <- mod_ests %>%
    filter(grepl('all-vc_severe', run_id) & stan_id != 'alpha') %>%
  or_table()

pretty_table(mod_ests_vc)
```

<br>

##### Gastroenteritis or non-V cholerae

```{r ge_nonvc confounding}
mod_ests_ge <- mod_ests %>%
  filter(grepl('all-ge_nonvc', run_id) & stan_id != 'alpha') %>%
  or_table()

pretty_table(mod_ests_ge)
```

<br>

### Sub-analyses

#### Vc or severe diarrhea

Is there still an effect of **being in an outbreak** when we subset the data to just case definitions specific to cholera or severe diarrhea (including death)?

```{r}
vc_coef <- mod_ests %>%
  filter(run_id %in% c('vc-uni-outbreak_desc'), stan_id != 'alpha') %>%
  or_table()

pretty_table(vc_coef)
```

<br>

#### Diarrhea

Is there still an effect of **recall period** when we subset the data to just case definitions for general diarrhea (not severe or resulting in death)?

```{r}
dia_coef <- mod_ests %>%
  filter(run_id %in% c('dia-uni-recall_time'), stan_id != 'alpha') %>%
  or_table()

pretty_table(dia_coef)
```

<br>

### Multivariate analysis

In the above analyses, found that we cannot separate effects of:

1.  time_care, self_or_child, & case_cat (gastroenteritis or other etiology)
2.  recall_time, outbreak_desc, & case_cat (V. cholerae or severe)

The trends with self_or_chid were also not significant or in the direction we expected, and so we're focusing on methods and case_cat in the multivariate analyses.

We run two analyses below, adjusting for methods and then adjusting for methods and case_cat. We do not adjust for recall period in the case_cat analysis because there was potential collinearity/confounding between those variables.

1.  In the first model, we test case_cat adjusting for time_care, assuming that case definition or symptoms are more directly related to care seeking than outbreak context or recall period (seems reasonable but can discuss).
2.  In the second model, we only include methods variables: timing of care seeking.

<br>

#### Factors associated with variation in care seeking rates

Odds that an individual with diarrhea seeks care for themselves or their child overall or by alternate case definitions, adjusting for different ways that the care seeking questions were asked (i.e., timing of care itself).

```{r coefs}
# pull mean coefficients
c2 <- mod_ests %>%
  filter(run_id %in% c('all-mod2'), stan_id != 'alpha')

c3 <- mod_ests %>%
  filter(run_id %in% c('all-mod3'), stan_id != 'alpha')

# make tables
or_table(c3) %>%
  pretty_table(title = 'Model including timing of care seeking')

or_table(c2) %>%
  pretty_table(title = 'Model including timing of care seeking question and case definition')
```

<br>

### Stratified estimates of care seeking by category

Stratifications correspond to questions that refer to any care seeking.

```{r}

# mean adjusted proportion positive
cs <- mod_ests %>%
  filter(stan_id == 'prop') %>%
  dplyr::select(run_id, lower, mean, upper) %>%
  mutate(run_id = ifelse(run_id %in% c('all-mod1', 'all-mod1-saL', 'all-mod1-saR'), 'Unadjusted', run_id),
         run_id = gsub(' \\(shift prior left\\)', '', run_id),
         run_id = gsub(' \\(shift prior right\\)', '', run_id)) %>%
  unique()

# table
tabs <- data.frame('Version' = c(rep('Main result', 5), 
                                 rep('Shift prior left', 5), 
                                 rep('Shift prior right', 5)),
                    'Model' = rep(c('1', 
                                    rep('2', 3),
                                    rep('3', 1)), 3),
                   'Variable' = cs$run_id,
                   'Proportion' = paste0(cs[,3],' (',cs[,2],' - ',cs[,4],')'))

names(tabs) <- c('Version', 'Model', 'Variable', 'Proportion (%)')
pretty_table(tabs)

```

<br>

```{r fig5, fig.height = 4, fig.width = 8}
#TODO: there is something weird with the gastroenteritis stratification; need to make sure there's not a bug in the code because it should have lower not higher care seeking
# - The if you take the weighted mean across the data, the trends are in this direction; unweighted, they are not. Not sure why this would cause the problem though as we don't take the mean in the post-strat mean calculation

# set colors
pal <- c('grey30', brewer.pal(n=6, name='Dark2'))

# update data frame for plotting
cs_plot <- cs[1:5,] %>% 
  mutate(facet = c('Unadjusted', 
                   rep('Stratum: Any care seeking; testing case definition', 3),
                   rep('Stratum: Any care seeking', 1))) 

cs_plot <- cs_plot %>%
  mutate(facet = factor(facet, levels = c(unique(cs_plot$facet)[1],
                                          unique(cs_plot$facet)[3],
                                          unique(cs_plot$facet)[2])))

# positivity plot
figs <- ggplot(cs_plot) +
          geom_point(aes(x = run_id, y = mean, color = run_id), size = 2) +
          geom_errorbar(aes(x = run_id, ymin = lower, ymax = upper, color = run_id), width = 0.3) +
          scale_color_manual(values = pal) +
          theme_bw() +
          theme(legend.position = 'none') +
          ylim(0,100) +
          ylab('Proportion (%)') + xlab(NULL) +
          scale_x_discrete(labels = label_wrap(15)) +
          facet_grid(.~facet, scales = 'free_x', space = 'free_x') +
          ggtitle('Proportion that sought care')

figs

```

<br>

### Forest plots

The "estimated" results are the study-level props from the model that includes time_care and case_cat.

```{r}
# underlying proportion seeking care by study
propseek <- readRDS(here::here('data', 'generated_data', 'care_seeking_estimates', 'propseek-all-mod2.rds'))
df_p <- propseek$p

# get mean and 95% CI by study
study_est <- data.frame(matrix(nrow=0, ncol=11))
names(study_est) <- c('study_id', 'country_iso3', 'time_care', 'self_or_child', 
                      'case_cat', 'n_did', 'n_did_survey', 'mean', 'lower', 'upper')
  
for (i in 1:ncol(df_p)) {
  study_est <- rbind(study_est,
                     data.frame(study_id = stan_dat[i, 'study_id'],
                                country_iso3 = stan_dat[i, 'country_iso3'],
                                time_care = stan_dat[i, 'time_care'],
                                self_or_child = stan_dat[i, 'self_or_child'],
                                case_cat = stan_dat[i, 'case_cat'],
                                n_did = stan_dat[i, 'n_did'],
                                n_did_survey = stan_dat[i, 'n_did_survey'],
                                mean = mean(df_p[, i][[1]], na.rm = T),
                                lower = quantile(df_p[, i][[1]], probs = .025, na.rm = T),
                                upper = quantile(df_p[, i][[1]], probs = .975, na.rm = T)))
}

# proportion seeking care by study
study_est <- study_est %>%
  mutate(p_did = n_did/n_did_survey) %>%
  group_by(study_id, country_iso3, time_care, self_or_child, case_cat,
           mean, upper, lower, p_did) %>%
  # binomial confidence intervals and variance for proportions
  summarize(p_lower = binomial_ci(p_did, n_did_survey)[[1]],
            p_upper = binomial_ci(p_did, n_did_survey)[[2]],
            vi = prop_var(p_did, n_did_survey)) %>%
  ungroup()
```

```{r i2, message = TRUE}
# calculate tau2, between-study heterogeneity or variance of the random effects by study
tau2 <- quantile(inv.logit(propseek$sigma_re$sigma_re), c(0.025, 0.5, 0.975))

# grab v, within-study sampling variance, dropping the study that reported 0 people seeking care
vi <- study_est%>%filter(vi!=0)%>%dplyr::select(vi)

# calculate i2
# https://www.metafor-project.org/doku.php/tips:i2_multilevel_multivariate#:~:text=For%20a%20standard%20random%2Deffects,ith%20i%20t
k <- nrow(stan_dat)-1 # dropped 1 study with 0 positives
sum_wi <- sum(1/vi[[1]])
sum_wi2 <- sum((1/vi[[1]])^2)
v <- ((k-1)*sum_wi)/(sum_wi^2-sum_wi2)
i2 <- 100*tau2/(tau2+v)

message('I2: ', paste0(round(i2,5), sep = ', '), '; tau2: ', paste0(round(tau2,5), sep = ', '))
```

```{r}
study_est <- study_est %>%
  # arrange from lowest to highest care seeking
  arrange(mean) %>%
  # create study labels
  mutate(study_lab = paste0(country_iso3, ' - ',
                            ifelse(self_or_child=='Self', 'Self  - ', 
                                   ifelse(self_or_child=='Child', 'Child - ', 'Other - ')),
                            ifelse(time_care=='Any care', 'Any  ', 
                                   ifelse(time_care=='First source', 'First', 'Prior'))))

# forest plot for diarrhea
dia_forest <- forest_plot(study_est %>% 
                     filter(case_cat=='Diarrhea') %>%
                     mutate(id = 1:nrow(study_est %>% filter(case_cat=='Diarrhea')))) +
  ggtitle('Diarrhea')

# forest plot for Severe diarrhea or cholera
vc_forest <- forest_plot(study_est %>% 
                        filter(case_cat=='Severe diarrhea or cholera') %>%
                        mutate(id = 1:nrow(study_est %>% filter(case_cat=='Severe diarrhea or cholera')))) +
  ggtitle('Severe diarrhea or cholera')

# forest plot for Gastroenteritis or non-Vc etiologies
ge_forest <- forest_plot(study_est %>% 
                     filter(case_cat=='Gastroenteritis or non-Vc etiologies') %>%
                     mutate(id = 1:nrow(study_est %>% filter(case_cat=='Gastroenteritis or non-Vc etiologies')))) +
  ggtitle('Gastroenteritis or non-Vc etiologies')

# look at unadjusted study estimates by stata
strat_est <- study_est %>%
  group_by(time_care, case_cat) %>%
    summarize(mean = round(mean(mean)*100,1),
              lower = round(mean(lower)*100,1),
              upper = round(mean(upper)*100,1)) %>%
    ungroup()
```

```{r fig4a, fig.height = 14, fig.width = 10}
dia_forest
```

```{r fig4b, fig.height = 3, fig.width = 10}
vc_forest
```

```{r fig4c, fig.height = 5, fig.width = 10}
ge_forest
```

<br>

## Where else do people seek care in LMICs?

### Data

```{r}
df_locs <- df %>%
  # restrict to LMICs
  filter(hic == 0) %>%
  # aggregate care seeking
  group_by_at(c('entry_id', 'entry_desc', 'region', 'location_type', 'study_type', 'sampling_method', 'pop_cat',
                'case_cat', 'outbreak_desc', 'location_desc', 'income_group', 'hic',
                'mult_choice', 'time_care', 'self_or_child', 'recall_time')) %>%
  summarize(n_did_survey = n_did_survey,
            n_did = ifelse(mult_choice == 0, sum(n_did), max(n_did))) %>%
  ungroup() %>%
  unique() %>%
  # proportion seeking care
  mutate(prop_seek = n_did/n_did_survey) %>%
  # format variables
  mutate(region = ifelse(region %in% c('Eastern Africa', 'Middle Africa', 'Southern Africa', 'Western Africa'),
                         'sub-Saharan Africa', region),
         outbreak_desc = ifelse(outbreak_desc == 1, 'Yes', 'No'),
         mult_choice = ifelse(mult_choice == 1, 'Yes', 'No'),
         pop_cat = ifelse(pop_cat %in% c('Child with malnutrition', 'Orphan', 'Relative/Caregiver (of adult)',
                                         'Street dweller', 'University student'), 'Other', pop_cat),
         recall_time = ifelse(recall_time < 14, '2-7 days',
                                   ifelse(recall_time == 14 | recall_time == 15, '14-15 days',
                                          ifelse(recall_time > 15 & recall_time <= 30, '27-30 days',
                                                 ifelse(recall_time > 30 & recall_time <= 90, '42-90 days',
                                                        ifelse(recall_time > 90, '170-365 days', 'Unknown'))))),
         recall_time = factor(recall_time,
                              levels = c('2-7 days', '14-15 days', '27-30 days', '42-90 days', '170-365 days', 'Unknown'))) %>%
  # factor variables
  mutate(study_type = factor(study_type,
                             levels = c('Survey', 'Surveillance',
                                        'Intervention', 'Case control')),
         sampling_method = factor(sampling_method,
                                  levels = c('Cluster', 'Systematic',
                                             'Simple random', 'All cases or households',
                                             'Stratified', 'Other')),
         location_desc = factor(location_desc,
                                levels = c('Rural', 'Urban', 'Urban and Rural',
                                           'Peri-Urban', 'Urban and Peri-Urban', 'IDP or Refugee Camp')),
         location_type = factor(location_type, 
                                levels = c('Any care outside home', 'Hospital/Clinic', 'Private Hospital/Clinic', 'Public Hospital/Clinic',
                                           'Other', 'Pharmacy', 'CHW', 'Health post', 'Friends/Family', 'Traditional Healer')))
```

#### Overall proportion seeking care by source

```{r, fig.width = 10}
floc1 <- plot_seekprop(df_locs, 'location_type', 
                       num_colors=10, palette = 'Spectral') +
  theme_dark() +
  theme(legend.position = 'none')

# df_locs %>%
#   group_by(location_type) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()

floc1
```

#### By source and study characteristic {.tabset}

##### Case definition

```{r, fig.width = 10, fig.height = 10}
floc2a <- plot_seekprop(df_locs, 'location_type', 
                       num_colors=10, palette = 'Spectral') +
  theme_dark() +
  theme(legend.position = 'none')

floc2a + facet_wrap('case_cat', ncol = 1)
```

```{r, fig.width = 8, fig.height = 11}
floc2b <- plot_seekprop(df_locs, 'case_cat', num_colors=3) +
  facet_wrap('location_type', ncol = 2)

floc2b
```

##### Income group

```{r, fig.width = 10, fig.height = 10}
floc3a <- plot_seekprop(df_locs, 'location_type', 
                       num_colors=10, palette = 'Spectral') +
  theme_dark() +
  theme(legend.position = 'none')

floc3a + facet_wrap('income_group', ncol = 1)
```

```{r, fig.width = 8, fig.height = 11}
floc3b <- plot_seekprop(df_locs, 'income_group', num_colors=3) +
  facet_wrap('location_type', ncol = 2)

floc3b
```

##### Timing of care seeking

```{r, fig.width = 10, fig.height = 10}
floc4a <- plot_seekprop(df_locs, 'location_type', 
                       num_colors=10, palette = 'Spectral') +
  theme_dark() +
  theme(legend.position = 'none')

floc4a + facet_wrap('time_care', ncol = 1)
```

```{r, fig.width = 8, fig.height = 11}
floc4b <- plot_seekprop(df_locs, 'time_care', num_colors=4) +
  facet_wrap('location_type', ncol = 2)

floc4b
```

##### Self or child

```{r, fig.width = 10, fig.height = 10}
floc5a <- plot_seekprop(df_locs, 'location_type', 
                       num_colors=10, palette = 'Spectral') +
  theme_dark() +
  theme(legend.position = 'none')

floc5a + facet_wrap('self_or_child', ncol = 1)
```

```{r, fig.width = 8, fig.height = 11}
floc5b <- plot_seekprop(df_locs, 'self_or_child', num_colors=3) +
  facet_wrap('location_type', ncol = 2)

floc5b
```

<br>

## Summary of key results

##### 1) Found the following trends in care seeking at hospital/clinic in the raw data:

-   Care seeking higher in an outbreak and for severe diarrhea or cholera
-   Variation in care seeking by LMIC/HIC tricky to separate from case definition
-   The way the care seeking question is asked influences care seeking, particularly timing of care, recall period, and whether the question is about self or child

##### 2) Found some trends towards higher care seeking at hospital/clinic for younger ages:

-   Very weak (not significant) positive correlation between proportion under 5 and proportion that sought care overall
-   Studies conducted only among children reported higher care seeking on average than studies conducted only among adults
-   This trend held for diarrhea and gastroenteritis but not for severe diarrhea or cholera

##### 3) Found high variation between studies, resulting in wide uncertainty around global estimates of proportion seeking care at hospitals/clinics

-   Wide range in study-level estimates and global estimate credible intervals, very high I2
-   Estimated proportion seeking care varied between 4 modeling approaches (3 different priors for Bayesian GLM, and non-Bayesian RE meta-analysis): 35% to 51%.

##### 4) The only factor that was clearly and consistently associated with variation in care seeking at hospitals/clinics was diarrhea case definition:

-   In univariate analysis, found that case definition, being in an outbreak, and being a caregiver of a patient at a health facility (as oppose to at home) were associated with higher odds of seeking care, while having a longer recall period was associated with lower odds of seeking care.
-   In bivariate analysis, found that we could not separate the effects of 1) recall period, case definition, and whether the study was about an individual or their child, or 2) recall period, case definition, and whether the study took place during an outbreak.
-   In sub-analysis, there was no longer an effect of being in an outbreak when sub-setting to just severe diarrhea or cholera, and there was no longer an effect of recall period when sub-setting to just general diarrhea.
-   In multivariate analysis, found that odds of seeking care for severe diarrhea or cholera were significantly higher than for general diarrhea, OR 3.15 (95% CrI 1.41-6.09), adjusting for timing of care seeking.

##### 5) Found the following trends in care seeking at other sources:

-   Hospitals/clinics are the most common source of care seeking outside the home across all categories examined
-   Seeking care from traditional healers was reported very rarely across all categories examined
-   Health posts and community health workers (CWH) are more commonly sought in low-income countries and as a first source of care
-   Care seeking anywhere outside the home was notably higher for an individual's child than for an individual themselves

<br>

## Additional things to consider

Sensitivity analyses (Skye found no differences):

-   study quality stratifications based on critical appraisals

Additional country- or study-level covariates to explore (Marissa working on):

-   Policies on free or affordable healthcare
-   Ratio of medical practitioners or CHWs to population

Supplementary analyses (potential, in rough order of importance):

-   would you seek care
-   assumptions about single-choice answers and where else people may seek care
-   recalculate proportion seeking care in hospital data to account for the fact that they're already at hospital (use Bayes rule)
