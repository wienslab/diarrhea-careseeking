---
title: "Diarrhea Care Seeking"
author: "Wiens Lab"
date: "2023"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
```

```{r package install, message = FALSE}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  countrycode, here, lubridate, tidyverse, ggplot2,
  sf, raster, RColorBrewer, cowplot, kableExtra, flextable
)

# custom functions
source(here::here('code', 'utils.R'))
```

```{r import and rename variables}
data_extraction <- here::here("data", "extracted_data", "data_extractions.csv")
data <- read.csv(data_extraction)

#Study Design
data_recode <- data %>% rename(study_id = Study.ID,
              study_title = Title,
              citation = Citation,
              study_type = Study.Type,
              sampling_method = Sampling.Method,
              study_pop = Study.Population,
              study_pop_cat = Study.population.category,
              case_definition = Case.Definition,
              case_definition_cat = Case.definition.category,
              sampling_start = Date.Start,
              sampling_end = Date.End,
              study_context = Study.Context,
              outbreak = Outbreak.Description,
              notes = Notes,
              # Location Information
              entry_id = Entry.ID,
              entry_desc = Entry.Description,
              country_iso3 = Country.ISO3.Code,
              admin0 = GADM.Admin.0,
              admin1 = GADM.Admin.1..when.available,
              admin2 = GADM.Admin.2..when.available,
              admin3 = GADM.Admin.3..when.available,
              place_name = Precise.Place.Name,
              location_desc = Urban.or.Rural,
              location_details = Location.Description,
              #Care Seeking Data
              care_questions = Care.Seeking.Questions,
              care_seeking_timing = Timing.of.care.seeking,
              self_or_child = Regarding.self.or.child,
              recall_time = Recall.time..in.days.,
              care_location = Facility.or.location.sought.as.written.in.transcript,
              location_type = Type.of.care.facility.sought..standardized.,
              n_would_survey = N.surveyed.if.they.WOULD.seek.care,
              n_would = N.who.said.they.WOULD.seek.care,
              n_did_survey = N.surveyed.if.they.DID.seek.care,
              n_did = N.who.actually.DID.seek.care,
              csd_notes = Additional.Information,
              age_l = Age.lower..of.individual.with.diarrhea.in.years.,
              age_r = Age.Upper..of.individual.with.diarrhea.in.years.,
              prop_under5 = Proportion.of.individuals.with.diarrhea..5.years.old,
              sex = Sex..of.individual.with.diarrhea.,
              diar_severe = Diarrhea.severity,
              diar_symp = Diarrhea.symptoms,
              nutrition = Nutrition.Status,
              entries_overlap = Overlapping.Study,
              num_convert = Percents.converted.to.numbers,
              mult_choice = Multiple.Choices,
              comments = Comments,
              extractor = Extractor.Initials,
              primary_dataset = Primary.dataset,
              strat_time = Stratified.time,
              strat_geo = Stratified.geographic.location,
              strat_location = Stratified.urban.rural,
              strat_age = Stratified.age,
              strat_sex = Stratified.sex,
              strat_severity = Stratified.severity
)

# Filter to primary dataset
data_recode <- data_recode %>%
  filter(primary_dataset == 1)

# some cleaning
data_recode <- data_recode %>%
  # simplify/clarify location description
  mutate(location_desc = ifelse(location_desc == 'IDP Camp (Internally Displaced Person) or Refugee Camp',
                                'IDP or Refugee Camp', 
                                ifelse(location_desc == 'Both', 'Urban and Rural', location_desc))) %>%
  # add start and end year
  mutate(sampling_start = as.Date(sampling_start, format = "%m/%d/%Y"),
         sampling_end = as.Date(sampling_end, format = "%m/%d/%Y"),
         TL = year(sampling_start),
         TR = year(sampling_end))
```

## Data Quality Checks

### Location information

```{r Quality Check, message = TRUE}
# quality check to make sure the ISO code is spelled correctly
data_recode$country_name <- countrycode(data_recode$country_iso3, "iso3c", "country.name")

wrong_iso <- data_recode %>%
  filter(is.na(country_name))

if (nrow(wrong_iso) > 0) {
  message('The following study_ids have incorrect ISO3 codes. They will be included for now but should be corrected:\n',
        paste0(unique(wrong_iso$study_id), sep = '\n'))
}
```

### Impossible values

```{r, message = TRUE}
# number surveyed larger than number surveyed
wrong_n <- data_recode %>%
  filter(n_did > n_did_survey)

if (nrow(wrong_n) > 0) {
  message('The following study_ids have the number surveyed smaller than the number that sought care. These will be excluded until fixed:\n',
        paste0(unique(wrong_n$study_id), sep = '\n'))

  # remove from data set until fixed
  data_recode <- data_recode %>%
    filter(n_did <= n_did_survey)
}

# start date is before end date
wrong_date <- data_recode %>%
  filter(sampling_start > sampling_end)

if (nrow(wrong_date) > 0) {
  message('The following study_ids have a sampling end date before a sampling start date. These will be excluded until fixed:\n',
        paste0(unique(wrong_date$study_id), sep = '\n'))

  # remove from data set until fixed
  data_recode <- data_recode %>%
    filter(n_did <= n_did_survey)
}
```

### Entry IDs

```{r, message = TRUE}
# entry_ids that have more than one N
wrong_eid <- data_recode %>%
  dplyr::select(c('entry_id', 'n_did_survey')) %>%
  unique() %>%
  group_by(entry_id) %>%
  reframe(n_check = sum(n_did_survey),
          n_did_survey = n_did_survey) %>%
  filter(n_did_survey != n_check)

wrong_eids <- unique(wrong_eid$entry_id)

if (length(wrong_eids) > 0) {
  message('The following entry_ids have more than one sample size listed and should be checked (they may need to be separated into multiple entry_ids). These will be excluded until fixed:\n',
        paste0(wrong_eids, sep = '\n'))

  # remove from data set until fixed
  data_recode <- data_recode %>%
    filter(!entry_id %in% wrong_eids)
}
```

<br>

## Maps
```{r, warning= FALSE}
# shapefile
shp <- st_read(here::here('data/shapefiles/ne_50m_admin_0_countries/ne_50m_admin_0_countries.shp'), quiet = TRUE)
shp <- shp %>% dplyr::select(ISO_A3, NAME_SORT, geometry)
```
```{r match-polygons}
# match each entry_id to a polygon
shp_list <- readRDS(here::here("data", "shapefiles", "shp_list.RData"))
# shp_list contains three shapefiles (shp_admin0, shp_admin1, shp_admin2), e.g. if the minimal admin level of an entry is 0 (country level), the shapefile can be found in shp_admin0. If an entry contains more than one place, the were separated into different rows, each has its own polygon.
```

## Data coverage by geography 

Number of observations in the primary dataset at each administrative level by country. Countries with >10 observations displayed as 10.

```{r figS1, fig.height = 10, fig.width = 7, warning = FALSE}
data_loc <- data_recode %>% 
  # select relevant study-period columns
  dplyr::select(c('study_id', 'entry_id', 'country_iso3',
                  'admin0', 'admin1', 'admin2', 'admin3', 'place_name')) %>%
  unique() %>%
  # only keep location names for lowest admin level
  mutate(admin0 = ifelse(admin1 == '' & admin2 == '' & admin3 == '', admin0, ''),
         admin1 = ifelse(admin2 == '' & admin3 == '', admin1, ''),
         admin2 = ifelse(admin3 == '', admin2, '')) %>%
  # reshape for counting
  reshape2::melt(measure.vars = c('admin0', 'admin1', 'admin2', 'admin3'),
                 id.vars = c('study_id', 'entry_id', 'country_iso3')) %>%
  # largest administrative level by observation
  filter(value != '') %>%
  group_by_at(c('study_id', 'entry_id', 'country_iso3')) %>%
  summarize(largest_admin = min(as.character(variable))) %>%
  ungroup() %>%
  # count observations by admin level
  count(country_iso3, largest_admin) %>% 
  rename(variable = largest_admin, observations = n) %>%
  ungroup()

# plot for each admin level
figS1 <- list()
for (i in 0:3) {
  figS1[[i+1]] <- data_map(data_loc, shp, ad = paste0('admin', i))
}

cowplot::plot_grid(figS1[[1]], figS1[[2]], figS1[[3]], figS1[[4]],
                   labels = c('A', 'B', 'C', 'D'),
                   ncol = 1)


# # number at each level
# data_loc %>%
#   group_by(variable) %>%
#   # count observations by admin level
#   summarize(observations = sum(observations)) %>%
#   ungroup() %>%
#   pretty_table()

# # numbers for Haiti
# data_loc %>%
#   filter(country_iso3 == 'HTI') %>%
#   group_by(variable) %>%
#   # count observations by admin level
#   summarize(observations = sum(observations)) %>%
#   ungroup() %>%
#   pretty_table()
```


<br>

### Data coverage over time

Number of observations in the primary dataset within different time periods. Year represents the year sampling was completed. Excludes 6 observations missing study dates.

```{r figS2, fig.height = 10, fig.width = 7}
# similar to those above, but instead of stratification by admin level, stratify into 4 time periods (before 2000~2004, 2005~2009, 2010~2014, after 2015)
coverage_time <- data_recode %>%
  # select relevant study-period columns
  dplyr::select(study_id, entry_id, country_iso3, sampling_end) %>%
  unique() %>%
  mutate(time_period = case_when(sampling_end <= as.Date("2004-12-31") ~ "2000~2004",
                                 sampling_end > as.Date("2004-12-31") & sampling_end <= as.Date("2009-12-31") ~ "2005~2009",
                                 sampling_end > as.Date("2009-12-31") & sampling_end <= as.Date("2014-12-31") ~ "2010~2014",
                                 sampling_end > as.Date("2014-12-31") ~ "2015~2020")) %>%
  # if multiple sampling periods within a time period, only report one observation
  dplyr::select(-sampling_end) %>%
  unique() %>%
  # if observations span multiple time periods, just report the end of the study period
  arrange(time_period) %>%
  group_by_at(c('study_id', 'entry_id', 'country_iso3')) %>% 
  mutate(num_dups = n(), 
         dup_id = row_number()) %>% 
  ungroup() %>% 
  mutate(is_duplicated = dup_id > 1) %>%
  filter(is_duplicated==FALSE) %>%
  dplyr::select(-is_duplicated) %>%
  # count by time (study ending time)
  count(country_iso3, time_period) %>% 
  rename(variable = time_period, observations = n) %>%
  ungroup()

# plot for each time period
figS2 <- list()
for (i in c("2000~2004", "2005~2009", "2010~2014", "2015~2020")) {
  figS2[[i]] <- data_map(coverage_time, shp, ad = i)
}

cowplot::plot_grid(figS2[[1]], figS2[[2]], figS2[[3]], figS2[[4]],
                   labels = c('A', 'B', 'C', 'D'),
                   ncol = 1)

# # number at each level
# coverage_time %>%
#   group_by(variable) %>%
#   # count observations by time period
#   summarize(observations = sum(observations)) %>%
#   ungroup() %>%
#   pretty_table()

# # numbers for Haiti
# coverage_time %>%
#   filter(country_iso3 == 'HTI') %>%
#   group_by(variable) %>%
#   # count observations by time period
#   summarize(observations = sum(observations)) %>%
#   ungroup() %>%
#   pretty_table()
```

<br>

## Calculate the Proportion of People Seeking Care by Entry ID

NB: this preliminary analysis excludes non-primary data, multiple choice questions, and "would you" questions

### Proportion By Care Facility

```{r, message = FALSE}
fac_sought_care <- data_recode %>% 
  dplyr::select(entry_id, mult_choice, location_type, n_did_survey, n_did) %>%
  filter(!is.na(n_did_survey) & mult_choice == 0) %>%
  dplyr::select(-mult_choice) %>%
  group_by(entry_id, location_type) %>%
  summarize(total_sought_care = sum(n_did),
            total_surveyed = first(n_did_survey)) %>%
  ungroup() %>%
  mutate(prop_sought_care = total_sought_care / total_surveyed)

```


```{r}
plot_care_location <- ggplot(fac_sought_care, aes(x = location_type, y = prop_sought_care)) +
  geom_boxplot(fill = "white", color = "black") +
  geom_point(aes(color = "black"), fill = "black", shape = 21, size = 1, alpha = 0.5,position = position_jitter(width = 0.2, height = 0)) +
  labs(title = "Proportion of People Seeking Care",
       x = "Location Type",
       y = "Proportion of People Seeking Care") +
  scale_color_manual(name = "Entry ID",
                     values = "black",
                     guide = "none") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(plot.title = element_text(size = 16),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12))

# Display the plot
plot_care_location

```

<br>

### Proportion by location setting

```{r, message = FALSE}
fac_sought_care <- data_recode %>% 
  dplyr::select(entry_id, mult_choice, location_desc, n_did_survey, n_did) %>%
  filter(!is.na(n_did_survey) & mult_choice == 0) %>%
  dplyr::select(-mult_choice) %>%
  group_by(entry_id, location_desc) %>%
  summarize(total_sought_care = sum(n_did),
            total_surveyed = first(n_did_survey)) %>%
  ungroup() %>%
  mutate(prop_sought_care = total_sought_care / total_surveyed)

```

```{r}
boxplot_plot <- ggplot(fac_sought_care, aes(x = location_desc, y = prop_sought_care)) +
  geom_boxplot(color = "black", outlier.shape = NA,  outlier.color = "white") + 
  geom_jitter(width = 0.2, height = 0, alpha = 0.5) +  # Adding jitter to the points
  coord_flip() +
  theme_bw() +
  labs(x = NULL, y = "Proportion of People who Sought Care") +
  ggtitle("Proportion of People who Sought Care Outside of the Home")

boxplot_plot


```

<br>

### Porportion by location setting and care facility

```{r, message = FALSE}
fac_sought_care <- data_recode %>% 
  dplyr::select(entry_id, mult_choice, location_desc, location_type, n_did_survey, n_did) %>%
  filter(!is.na(n_did_survey) & mult_choice == 0) %>%
  dplyr::select(-mult_choice) %>%
  group_by(entry_id, location_desc, location_type) %>%
  summarize(total_sought_care = sum(n_did),
            total_surveyed = first(n_did_survey)) %>%
  ungroup() %>%
  mutate(prop_sought_care = total_sought_care / total_surveyed)

```

<br>

#### By All Hospital/Clinics

```{r}
# Create a new location_type "All Hospital/Clinic"
gen_hos_fac_filtered_data <- fac_sought_care %>%
  mutate(location_type = ifelse(location_type %in% c("Public Hospital/Clinic", "Private Hospital/Clinic", "Hospital/Clinic"),
                                "All Hospital/Clinic",
                                location_type))

# Filter data for all hospital/clinics
gen_hos_filtered_data <- gen_hos_fac_filtered_data %>%
  filter(location_type == "All Hospital/Clinic")

# Create plot
gen_hos_care_facility_plot <- ggplot(gen_hos_filtered_data, aes(x = location_desc, y = prop_sought_care)) +
  geom_boxplot(color = "black", outlier.shape = NA,  outlier.color = "white") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  coord_flip() +
  theme_minimal() +
  labs(x = NULL, y = "Proportion of People who Sought Care") +
  ggtitle("Proportion who Sought Care at any Hospital/Clinic")

# Print the plot
gen_hos_care_facility_plot

```

<br>

#### By Public Hospital/Clinic

```{r,}
# Filter data for public hospitals/clinics
pub_hos_filtered_data <- fac_sought_care %>%
  filter(location_type == "Public Hospital/Clinic")

# Create plot
public_hospital_plot <- ggplot(pub_hos_filtered_data, aes(x = location_desc, y = prop_sought_care)) +
  geom_boxplot(color = "black", outlier.shape = NA,  outlier.color = "white") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  coord_flip() +
  theme_minimal() +
  labs(x = NULL, y = "Proportion of People who Sought Care") +
  ggtitle("Proportion who Sought Care at Public Hospital/Clinic")

# Print the plot
print(public_hospital_plot)

```

<br>

#### By Private Hospital/Clinic

```{r}
# Filter data for Private hospitals/clinics
pri_hos_filtered_data <- fac_sought_care %>%
  filter(location_type == "Private Hospital/Clinic")

# Create plot
private_hospital_plot <- ggplot(pri_hos_filtered_data, aes(x = location_desc, y = prop_sought_care)) +
  geom_boxplot(color = "black", outlier.shape = NA,  outlier.color = "white") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  coord_flip() +
  theme_minimal() +
  labs(x = NULL, y = "Proportion of People who Sought Care") +
  ggtitle("Proportion who Sought Care at Private Hospital/Clinic")

# Print the plot
print(private_hospital_plot)
```

<br>

#### By Pharmacy

```{r}
# Filter data for Pharmacy
pharm_filtered_data <- fac_sought_care %>%
  filter(location_type == "Pharmacy")

# Create plot
pharm_plot <- ggplot(pharm_filtered_data, aes(x = location_desc, y = prop_sought_care)) +
  geom_boxplot(color = "black", outlier.shape = NA,  outlier.color = "white") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  coord_flip() +
  theme_minimal() +
  labs(x = NULL, y = "Proportion of People who Sought Care") +
  ggtitle("Proportion who Sought Care at Pharmacy")

# Print the plot
print(pharm_plot)
```

<br>

#### By Traditional Healer

```{r}
# Filter data for Traditional Healer
trad_heal_filtered_data <- fac_sought_care %>%
  filter(location_type == "Traditional Healer")

# Create plot
trad_heal_plot <- ggplot(trad_heal_filtered_data, aes(x = location_desc, y = prop_sought_care)) +
  geom_boxplot(color = "black", outlier.shape = NA,  outlier.color = "white") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  coord_flip() +
  theme_minimal() +
  labs(x = NULL, y = "Proportion of People who Sought Care") +
  ggtitle("Proportion who Sought Care at Traditional Healer")

# Print the plot
print(trad_heal_plot)
```

<br>

#### By Non-Hospital/Clinic

```{r}
# Filter data for Non-Hospital/Clinic
non_hos_filtered_data <- fac_sought_care %>%
  filter(location_type == "Non-Hospital/Clinic")

# Create plot
non_hos_plot <- ggplot(non_hos_filtered_data, aes(x = location_desc, y = prop_sought_care)) +
  geom_boxplot(color = "black", outlier.shape = NA,  outlier.color = "white") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  coord_flip() +
  theme_minimal() +
  labs(x = NULL, y = "Proportion of People who Sought Care") +
  ggtitle("Proportion who Sought Care at Non-Hospital/Clinic")

# Print the plot
print(non_hos_plot)
```

<br>

## Cholera or watery diarrhea

```{r}
data_vc <- data_recode %>% 
  filter(case_definition_cat == 'Cholera (watery diarrhea)' | case_definition_cat == 'Cholera death')
```

```{r load-incidence}
# load calculated estimated incidence (based on raster) from folder, the raster we have only covers sub-saharan Africa, other places were marked as NA
data_vc <- suppressMessages(load_incidence(data_vc))
```

Primary observations, non-multiple choice answers, and countries where we have non-zero or non-NA cholera incidence estimates. We also have cholera-specific care seeking data for Haiti, Zimbabwe, and Kenya.

```{r, warning = FALSE, fig.width=5, fig.height=3.5}
vc_sought_care <- data_vc %>% 
  dplyr::select(entry_id, country_iso3, mult_choice, location_type, n_did_survey, n_did, inc_calc) %>%
  filter(!is.na(n_did_survey) & mult_choice == 0) %>%
  dplyr::select(-mult_choice) %>%
  group_by(entry_id, location_type, inc_calc, country_iso3) %>%
  summarize(total_sought_care = sum(n_did),
            total_surveyed = first(n_did_survey)) %>%
  ungroup() %>%
  mutate(prop_sought_care = total_sought_care / total_surveyed)

ggplot(vc_sought_care, aes(x = inc_calc, y = prop_sought_care, label = country_iso3)) +
  geom_point() + geom_text(hjust = 0, vjust = 0) +
  theme_bw() + 
  xlab('Estimated cholera incidence') + ylab('Proportion seeking care outside home')

cor.test(vc_sought_care$inc_calc, vc_sought_care$prop_sought_care, use = "complete.obs")
```


