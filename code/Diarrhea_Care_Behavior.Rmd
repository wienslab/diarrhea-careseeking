---
title: "Diarrhea Care Seeking"
author: "Wiens Lab"
date: "2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
```

```{r package install, message = FALSE}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  countrycode,googlesheets4, dplyr, rio, 
  here, janitor, tsibble, lubridate, skimr, 
  tidyverse, gtsummary, dlookr, tinytex, ggplot2
)
```

```{r import and rename variables}
data_extraction <- here::here("data", "data_extractions.csv")
data <- read.csv(data_extraction)

#Study Design
data_recode <- data %>% rename(study_id = Study.ID,
              study_title = Title,
              citation = Citation,
              study_type = Study.Type,
              sampling_method = Sampling.Method,
              study_pop = Study.Population,
              case_definition = Case.Definition,
              sampling_start = Date.Start,
              sampling_end = Date.End,
              study_context = Study.Context,
              outbreak = Outbreak.Description,
              notes = Notes,
              # Location Information
              entry_id = Entry.ID,
              entry_desc = Entry.Description,
              country = Country.ISO3.Code,
              admin0 = GADM.Admin.0,
              admin1 = GADM.Admin.1..when.available,
              admin2 = GADM.Admin.2..when.available,
              admin3 = GADM.Admin.3..when.available,
              place_name = Precise.Place.Name,
              location_desc = Urban.or.Rural,
              location_details = Location.Description,
              #Care Seeking Data
              care_questions = Care.Seeking.Questions,
              self_or_child = Regarding.self.or.child,
              recall_time = Recall.time..in.days.,
              care_location = Facility.or.location.sought.as.written.in.transcript,
              location_type = Type.of.care.facility.sought..standardized.,
              n_would_survey = N.surveyed.if.they.WOULD.seek.care,
              n_would = N.who.said.they.WOULD.seek.care,
              n_did_survey = N.surveyed.if.they.DID.seek.care,
              n_did = N.who.actually.DID.seek.care,
              csd_notes = Additional.Information,
              age_l = Age.lower..of.individual.with.diarrhea.in.years.,
              age_r = Age.Upper..of.individual.with.diarrhea.in.years.,
              sex = Sex..of.individual.with.diarrhea.,
              diar_severe = Diarrhea.severity,
              diar_symp = Diarrhea.symptoms,
              entries_overlap = Overlapping.Study,
              num_convert = Percents.converted.to.numbers,
              mult_choice = Multiple.Choices,
              comments = Comments,
              extractor = Extractor.Initials,
              primary_dataset = Primary.dataset,
              strat_time = Stratified.time,
              strat_geo = Stratified.geographic.location,
              strat_location = Stratified.urban.rural,
              strat_age = Stratified.age,
              strat_sex = Stratified.sex,
              strat_severity = Stratified.severity
)

# Filter to primary dataset
data_recode <- data_recode %>%
  filter(primary_dataset == 1)

# Simplify/clarify location description
data_recode <- data_recode %>%
  mutate(location_desc = ifelse(location_desc == 'IDP Camp (Internally Displaced Person) or Refugee Camp',
                                'IDP or Refugee Camp', 
                                ifelse(location_desc == 'Both', 'Urban and Rural', location_desc)))
```

## Data Quality Checks

### Location information

```{r Quality Check}
# quality check to make sure the ISO code is spelled correctly
data_recode$country_name <- countrycode(data_recode$country, "iso3c", "country.name")

wrong_iso <- data_recode %>%
  filter(is.na(country_name))

if (nrow(wrong_iso) > 0) {
  message('The following study_ids have incorrect ISO3 codes. They will be included for now but should be corrected:\n',
        paste0(unique(wrong_iso$study_id), sep = '\n'))
}
```

### Impossible values

```{r}
# number surveyed larger than number surveyed
wrong_n <- data_recode %>%
  filter(n_did > n_did_survey)

if (nrow(wrong_n) > 0) {
  message('The following study_ids have the number surveyed smaller than the number that sought care. These will be excluded until fixed:\n',
        paste0(unique(wrong_n$study_id), sep = '\n'))

  # remove from data set until fixed
  data_recode <- data_recode %>%
    filter(n_did <= n_did_survey)
}
```

### Entry IDs

```{r}
# entry_ids that have more than one N
wrong_eid <- data_recode %>%
  select(c('entry_id', 'n_did_survey')) %>%
  unique() %>%
  group_by(entry_id) %>%
  reframe(n_check = sum(n_did_survey),
          n_did_survey = n_did_survey) %>%
  filter(n_did_survey != n_check)

wrong_eids <- unique(wrong_eid$entry_id)

if (length(wrong_eids) > 0) {
  message('The following entry_ids have more than one sample size listed and should be checked (they may need to be separated into multiple entry_ids). These will be excluded until fixed:\n',
        paste0(wrong_eids, sep = '\n'))

  # remove from data set until fixed
  data_recode <- data_recode %>%
    filter(!entry_id %in% wrong_eids)
}
```

<br>

## Calculate the Proportion of People Seeking Care by Entry ID

NB: this preliminary analysis excludes non-primary data, multiple choice questions, and "would you" questions

### Proportion By Care Facility

```{r, message = FALSE}
fac_sought_care <- data_recode %>% 
  select(entry_id, mult_choice, location_type, n_did_survey, n_did) %>%
  filter(!is.na(n_did_survey) & mult_choice == 0) %>%
  select(-mult_choice) %>%
  group_by(entry_id, location_type) %>%
  summarize(total_sought_care = sum(n_did),
            total_surveyed = first(n_did_survey)) %>%
  ungroup() %>%
  mutate(prop_sought_care = total_sought_care / total_surveyed)

```


```{r}
plot_care_location <- ggplot(fac_sought_care, aes(x = location_type, y = prop_sought_care)) +
  geom_boxplot(fill = "white", color = "black") +
  geom_point(aes(color = "black"), fill = "black", shape = 21, size = 1, alpha = 0.5,position = position_jitter(width = 0.2, height = 0)) +
  labs(title = "Proportion of People Seeking Care",
       x = "Location Type",
       y = "Proportion of People Seeking Care") +
  scale_color_manual(name = "Entry ID",
                     values = "black",
                     guide = "none") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(plot.title = element_text(size = 16),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12))

# Display the plot
plot_care_location

```

<br>

### Proportion by location setting

```{r, message = FALSE}
fac_sought_care <- data_recode %>% 
  select(entry_id, mult_choice, location_desc, n_did_survey, n_did) %>%
  filter(!is.na(n_did_survey) & mult_choice == 0) %>%
  select(-mult_choice) %>%
  group_by(entry_id, location_desc) %>%
  summarize(total_sought_care = sum(n_did),
            total_surveyed = first(n_did_survey)) %>%
  ungroup() %>%
  mutate(prop_sought_care = total_sought_care / total_surveyed)

```

```{r}
boxplot_plot <- ggplot(fac_sought_care, aes(x = location_desc, y = prop_sought_care)) +
  geom_boxplot(color = "black", outlier.shape = NA,  outlier.color = "white") + 
  geom_jitter(width = 0.2, height = 0, alpha = 0.5) +  # Adding jitter to the points
  coord_flip() +
  theme_bw() +
  labs(x = NULL, y = "Proportion of People who Sought Care") +
  ggtitle("Proportion of People who Sought Care Outside of the Home")

boxplot_plot


```

<br>

### Porportion by location setting and care facility

```{r, message = FALSE}
fac_sought_care <- data_recode %>% 
  select(entry_id, mult_choice, location_desc, location_type, n_did_survey, n_did) %>%
  filter(!is.na(n_did_survey) & mult_choice == 0) %>%
  select(-mult_choice) %>%
  group_by(entry_id, location_desc, location_type) %>%
  summarize(total_sought_care = sum(n_did),
            total_surveyed = first(n_did_survey)) %>%
  ungroup() %>%
  mutate(prop_sought_care = total_sought_care / total_surveyed)

```

<br>

#### By All Hospital/Clinics

```{r}
# Create a new location_type "All Hospital/Clinic"
gen_hos_fac_filtered_data <- fac_sought_care %>%
  mutate(location_type = ifelse(location_type %in% c("Public Hospital/Clinic", "Private Hospital/Clinic", "Hospital/Clinic"),
                                "All Hospital/Clinic",
                                location_type))

# Filter data for all hospital/clinics
gen_hos_filtered_data <- gen_hos_fac_filtered_data %>%
  filter(location_type == "All Hospital/Clinic")

# Create plot
gen_hos_care_facility_plot <- ggplot(gen_hos_filtered_data, aes(x = location_desc, y = prop_sought_care)) +
  geom_boxplot(color = "black", outlier.shape = NA,  outlier.color = "white") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  coord_flip() +
  theme_minimal() +
  labs(x = NULL, y = "Proportion of People who Sought Care") +
  ggtitle("Proportion who Sought Care at any Hospital/Clinic")

# Print the plot
gen_hos_care_facility_plot

```

<br>

#### By Public Hospital/Clinic

```{r,}
# Filter data for public hospitals/clinics
pub_hos_filtered_data <- fac_sought_care %>%
  filter(location_type == "Public Hospital/Clinic")

# Create plot
public_hospital_plot <- ggplot(pub_hos_filtered_data, aes(x = location_desc, y = prop_sought_care)) +
  geom_boxplot(color = "black", outlier.shape = NA,  outlier.color = "white") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  coord_flip() +
  theme_minimal() +
  labs(x = NULL, y = "Proportion of People who Sought Care") +
  ggtitle("Proportion who Sought Care at Public Hospital/Clinic")

# Print the plot
print(public_hospital_plot)

```

<br>

#### By Private Hospital/Clinic

```{r}
# Filter data for Private hospitals/clinics
pri_hos_filtered_data <- fac_sought_care %>%
  filter(location_type == "Private Hospital/Clinic")

# Create plot
private_hospital_plot <- ggplot(pri_hos_filtered_data, aes(x = location_desc, y = prop_sought_care)) +
  geom_boxplot(color = "black", outlier.shape = NA,  outlier.color = "white") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  coord_flip() +
  theme_minimal() +
  labs(x = NULL, y = "Proportion of People who Sought Care") +
  ggtitle("Proportion who Sought Care at Private Hospital/Clinic")

# Print the plot
print(private_hospital_plot)
```

<br>

#### By Pharmacy

```{r}
# Filter data for Pharmacy
pharm_filtered_data <- fac_sought_care %>%
  filter(location_type == "Pharmacy")

# Create plot
pharm_plot <- ggplot(pharm_filtered_data, aes(x = location_desc, y = prop_sought_care)) +
  geom_boxplot(color = "black", outlier.shape = NA,  outlier.color = "white") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  coord_flip() +
  theme_minimal() +
  labs(x = NULL, y = "Proportion of People who Sought Care") +
  ggtitle("Proportion who Sought Care at Pharmacy")

# Print the plot
print(pharm_plot)
```

<br>

#### By Traditional Healer

```{r}
# Filter data for Traditional Healer
trad_heal_filtered_data <- fac_sought_care %>%
  filter(location_type == "Traditional Healer")

# Create plot
trad_heal_plot <- ggplot(trad_heal_filtered_data, aes(x = location_desc, y = prop_sought_care)) +
  geom_boxplot(color = "black", outlier.shape = NA,  outlier.color = "white") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  coord_flip() +
  theme_minimal() +
  labs(x = NULL, y = "Proportion of People who Sought Care") +
  ggtitle("Proportion who Sought Care at Traditional Healer")

# Print the plot
print(trad_heal_plot)
```

<br>

#### By Non-Hospital/Clinic

```{r}
# Filter data for Non-Hospital/Clinic
non_hos_filtered_data <- fac_sought_care %>%
  filter(location_type == "Non-Hospital/Clinic")

# Create plot
non_hos_plot <- ggplot(non_hos_filtered_data, aes(x = location_desc, y = prop_sought_care)) +
  geom_boxplot(color = "black", outlier.shape = NA,  outlier.color = "white") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  coord_flip() +
  theme_minimal() +
  labs(x = NULL, y = "Proportion of People who Sought Care") +
  ggtitle("Proportion who Sought Care at Non-Hospital/Clinic")

# Print the plot
print(non_hos_plot)
```

<br>
