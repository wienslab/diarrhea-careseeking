---
title: "A systematic review and meta-analysis of care seeking for diarrheal illness"
author: "Kirsten E. Wiens, Marissa Miller, Daniel P. Costello, Ashlynn Solomon, ..., Elizabeth C. Lee, Andrew S. Azman"
output: 
  html_document:
    toc: true
    toc_float: true
---

<br>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      dev=c('png', 'pdf'), fig.path='figures/')
knitr::opts_knit$set(root.dir = here::here())
```

```{r preamble, warning = TRUE}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  countrycode, here, lubridate, tidyverse, ggplot2, doParallel, boot,
  sf, raster, RColorBrewer, cowplot, kableExtra, flextable
)

# custom functions
source(here::here('code', 'utils.R'))
```

## Draft outline

#### Our primary question is: What proportion of people with diarrhea seek care at a place that they'd likely get counted (i.e., hospital/clinic) when they have diarrhea?

-   Age and sex
-   Symptoms
-   Study methods
-   Urban/rural
-   How study question is phrased
-   Study population
-   Travel distance to health facility\^
-   Health care state/access (at country level)\^
-   Density of population to healthcare providers (country)\^
-   HIC vs LMICs

\^Still need to pull this data

Additional things to consider:

-   Multiple choice questions
-   How question is phrased
-   Whether the above characteristics should be covs or strats

#### Our secondary question is: Where else do they seek care?

<br>

```{r load and tidy data}

#  load data
df <- read.csv(here::here('data', 'extracted_data', 'data_extractions.csv'))
vars <- read.csv(here::here('data', 'extracted_data', 'data_codebook.csv'))

# set column variable names
df$Status <- NULL
if(nrow(vars) != ncol(df)) stop('Codebook does not match extractions. Please check variables.')
names(df) <- vars$Variable

# filter to primary non-overlapping dataset
df <- df %>%
  filter(primary_set == 1)

# format columns
df <- df %>%
  # simplify/clarify location description
  mutate(location_desc = ifelse(location_desc == 'IDP Camp (Internally Displaced Person) or Refugee Camp',
                                'IDP or Refugee Camp', 
                                ifelse(location_desc == 'Both', 'Urban and Rural', location_desc))) %>%
  # add start and end year
  mutate(sampling_start = as.Date(sampling_start, format = "%m/%d/%Y"),
         sampling_end = as.Date(sampling_end, format = "%m/%d/%Y"),
         TL = year(sampling_start),
         TR = year(sampling_end)) %>%
  # region as defined by World Bank Development Indicators
  mutate(region = countrycode(country_iso3, 
                              origin = 'iso3c', 
                              destination = 'region')) %>%
  mutate(region = ifelse(region != 'Sub-Saharan Africa',
                         region, 
                         countrycode(country_iso3, 
                                     origin = 'iso3c', 
                                     destination = 'region23'))) %>%
  # whether or not an outbreak description was provided
  mutate(outbreak_desc = ifelse(outbreak == 'No outbreak description' | outbreak == 'Pre outbreak', 0, 1)) %>%
  # set "other" to "any care" for timing (based on descriptions in notes)
  mutate(time_care = ifelse(time_care == 'Other (write in notes)', 'Any care', time_care))

# main dataset is whether people DID seek care; also create df for when people WOULD seek care
df_would <- df %>%
  filter(!is.na(n_would_survey)) %>%
  dplyr::select(-n_did_survey, -n_did)

df <- df %>%
  filter(!is.na(n_did_survey)) %>%
  dplyr::select(-n_would_survey, -n_would)
```

```{r aggregate stratifications}
# # variables to keep
# keep_vars <- c('study_id', 'study_type', 'sampling_method', 'pop_cat', 'case_cat', 'outbreak_desc',
#                'sampling_start', 'sampling_end', 'TL', 'TR', 'region', 'country_iso3', 'admin0', 
#                'mult_choice', 'time_care', 'self_or_child', 'recall_time', 'location_type')
# 
# # aggregate stratifications by taking weighted mean
# # this will be our main analysis dataset
# df <- df %>%
#   group_by_at(keep_vars) %>%
#   summarize(prop_five = ifelse(!is.na(n_would_survey), weighted.mean(prop_five, n_would_survey, na.rm=T),
#                                ifelse(!is.na(n_did_survey), weighted.mean(prop_five, n_did_survey, na.rm=T, NA))),
#             #TODO: need to think carefully about how these should be aggregated, given mult choice, strats, entry_ids, etc.
#             # stick with entry_id for now for the data plots
#             n_cases_tested = sum(n_cases_tested, na.rm = TRUE)) %>%
#   ungroup()
```

## Systematic review

### Fig 1. PRISMA diagram

![PRISMA diagram.](PRISMA-20231218.png)

<br>

## Data

**Note:** Unless otherwise noted, the data presented below represents 161 studies (381 stratified observation entries) in the **primary, non-overlapping** dataset that asked study participants whether or not the **DID** seek care for a past diarrheal illness.

We also have information on whether individuals **would** seek care for a hypothetical diarrheal illness from 27 studies (96 stratified observation entries).

### Data coverage by geography

```{r, warning= FALSE}
# shapefile
shp <- st_read(here::here('data/shapefiles/ne_50m_admin_0_countries/ne_50m_admin_0_countries.shp'), quiet = TRUE)
shp <- shp %>% dplyr::select(ISO_A3, NAME_SORT, geometry)
```

```{r match-polygons}
# match each entry_id to a polygon
shp_list <- readRDS(here::here("data", "shapefiles", "shp_list.RData"))
# shp_list contains three shapefiles (shp_admin0, shp_admin1, shp_admin2), e.g. if the minimal admin level of an entry is 0 (country level), the shapefile can be found in shp_admin0. If an entry contains more than one place, the were separated into different rows, each has its own polygon.
```

Number of stratified observation entries in the primary dataset at each administrative level by country. Countries with \>10 observations displayed as 10.

```{r figS1, fig.height = 10, fig.width = 7, warning = FALSE}
data_loc <- df %>% 
  # select relevant study-period columns
  dplyr::select(c('study_id', 'entry_id', 'country_iso3',
                  'admin0', 'admin1', 'admin2', 'admin3', 'place_name')) %>%
  unique() %>%
  # only keep location names for lowest admin level
  mutate(admin0 = ifelse(admin1 == '' & admin2 == '' & admin3 == '', admin0, ''),
         admin1 = ifelse(admin2 == '' & admin3 == '', admin1, ''),
         admin2 = ifelse(admin3 == '', admin2, '')) %>%
  # reshape for counting
  reshape2::melt(measure.vars = c('admin0', 'admin1', 'admin2', 'admin3'),
                 id.vars = c('study_id', 'entry_id', 'country_iso3')) %>%
  # largest administrative level by observation
  filter(value != '') %>%
  group_by_at(c('study_id', 'entry_id', 'country_iso3')) %>%
  summarize(largest_admin = min(as.character(variable))) %>%
  ungroup() %>%
  # count observations by admin level
  count(country_iso3, largest_admin) %>% 
  rename(variable = largest_admin, observations = n) %>%
  ungroup()

# plot for each admin level
figS1 <- list()
for (i in 0:3) {
  figS1[[i+1]] <- data_map(data_loc, shp, ad = paste0('admin', i))
}

cowplot::plot_grid(figS1[[1]], figS1[[2]], figS1[[3]], figS1[[4]],
                   labels = c('A', 'B', 'C', 'D'),
                   ncol = 1)


# # number at each level
# data_loc %>%
#   group_by(variable) %>%
#   # count observations by admin level
#   summarize(observations = sum(observations)) %>%
#   ungroup() %>%
#   pretty_table()

# # numbers for Haiti
# data_loc %>%
#   filter(country_iso3 == 'HTI') %>%
#   group_by(variable) %>%
#   # count observations by admin level
#   summarize(observations = sum(observations)) %>%
#   ungroup() %>%
#   pretty_table()
```

<br>

### Data coverage over time

Number of stratified observation entries in the primary dataset within different time periods. Year represents the year sampling was completed. Excludes 6 entries missing study dates.

```{r figS2, fig.height = 10, fig.width = 7}
# similar to those above, but instead of stratification by admin level, stratify into 4 time periods (before 2000~2004, 2005~2009, 2010~2014, after 2015)
coverage_time <- df %>%
  # select relevant study-period columns
  dplyr::select(study_id, entry_id, country_iso3, sampling_end) %>%
  unique() %>%
  mutate(time_period = case_when(sampling_end <= as.Date("2004-12-31") ~ "2000~2004",
                                 sampling_end > as.Date("2004-12-31") & sampling_end <= as.Date("2009-12-31") ~ "2005~2009",
                                 sampling_end > as.Date("2009-12-31") & sampling_end <= as.Date("2014-12-31") ~ "2010~2014",
                                 sampling_end > as.Date("2014-12-31") ~ "2015~2022")) %>%
  # if multiple sampling periods within a time period, only report one observation
  dplyr::select(-sampling_end) %>%
  unique() %>%
  # if observations span multiple time periods, just report the end of the study period
  arrange(time_period) %>%
  group_by_at(c('study_id', 'entry_id', 'country_iso3')) %>% 
  mutate(num_dups = n(), 
         dup_id = row_number()) %>% 
  ungroup() %>% 
  mutate(is_duplicated = dup_id > 1) %>%
  filter(is_duplicated==FALSE) %>%
  dplyr::select(-is_duplicated) %>%
  # count by time (study ending time)
  count(country_iso3, time_period) %>% 
  rename(variable = time_period, observations = n) %>%
  ungroup()

# plot for each time period
figS2 <- list()
for (i in c("2000~2004", "2005~2009", "2010~2014", "2015~2022")) {
  figS2[[i]] <- data_map(coverage_time, shp, ad = i)
}

cowplot::plot_grid(figS2[[1]], figS2[[2]], figS2[[3]], figS2[[4]],
                   labels = c('A', 'B', 'C', 'D'),
                   ncol = 1)

# # number at each level
# coverage_time %>%
#   group_by(variable) %>%
#   # count observations by time period
#   summarize(observations = sum(observations)) %>%
#   ungroup() %>%
#   pretty_table()

# # numbers for Haiti
# coverage_time %>%
#   filter(country_iso3 == 'HTI') %>%
#   group_by(variable) %>%
#   # count observations by time period
#   summarize(observations = sum(observations)) %>%
#   ungroup() %>%
#   pretty_table()
```

<br>

### Study (entry_id) characteristics

```{r table1}

# prep variables for table
sd <- df %>% 
  # format variables
  mutate(outbreak_desc = ifelse(outbreak_desc == 1, 'Yes', 'No')) %>%
  # sum up number of tests and sample sizes by observation
  dplyr::select(c('entry_id', 'study_type', 'sampling_method', 'pop_cat', 'case_cat', 'outbreak_desc', 'location_desc')) %>%
  unique() %>%
  dplyr::select(-entry_id) 

# summarize and make table
sd %>%
  summarize_cats() %>%
  arrange(desc(variable), desc(Percent)) %>%
  mutate(variable = ifelse(variable == 'Pop cat', 'Study population',
                           ifelse(variable == 'Case cat', 'Case definition',
                                  ifelse(variable == 'Outbreak desc', 'Outbreak described', variable)))) %>%
  pretty_table()

# sd %>%
#   summarize_cats() %>%
#   flextable() %>%
#   save_as_docx(path = here::here('code/tables/table1.docx'))
```

<br>

### Care seeking questions

**Note:** "Other" regarding self or child almost always refers to all household members, or is a combination of self and child that we could not disaggregate.

```{r table2}

# prep variables for table
cq <- df %>% 
  # format variables
  mutate(recall_time = ifelse(recall_time < 14, '2-7 days',
                                   ifelse(recall_time == 14 | recall_time == 15, '14-15 days',
                                          ifelse(recall_time > 15 & recall_time <= 30, '27-30 days', 
                                                 ifelse(recall_time > 30 & recall_time <= 90, '42-90 days',
                                                        ifelse(recall_time > 90, '170-365 days', 'Unknown'))))),
         mult_choice = ifelse(mult_choice == 1, 'Yes', 'No')) %>%
  # sum up number of tests and sample sizes by observation
  dplyr::select(c('entry_id', 'mult_choice', 'time_care', 'self_or_child', 'recall_time')) %>%
  unique() %>%
  dplyr::select(-entry_id) 

# summarize and make table
cq %>%
  summarize_cats() %>%
  arrange(desc(variable), desc(Percent)) %>%
  pretty_table()

# cq %>%
#   summarize_cats() %>%
#   flextable() %>%
#   save_as_docx(path = here::here('code/tables/table1.docx'))
```

<br>

### Proportion seeking care at a hospital or clinic

**Note:** This excludes individuals seeking care exclusively or explicitly at private hospitals/clinics, i.e., this includes location categories "Hospital/Clinic" (general) and "Public Hospital/Clinic" (more specific).

*For multiple choice questions where there is more than one category of hospital/clinic, we take the largest proportion that sought care across them. This is not entirely accurate but the best we can do here. May want to return to this.*

<br>

#### By study (entry_id) characteristics

```{r}
df_hosp <- df %>%
  # filter to hospital/clinic (not private)
  filter(location_type %in% c('Hospital/Clinic', 'Public Hospital/Clinic')) %>%
  # aggregate care seeking
  group_by_at(c('entry_id', 'entry_desc', 'study_type', 'sampling_method', 'pop_cat', 
                'case_cat', 'outbreak_desc', 'location_desc', 
                'mult_choice', 'time_care', 'self_or_child', 'recall_time')) %>%
  summarize(n_did_survey = n_did_survey,
            n_did = ifelse(mult_choice == 0, sum(n_did), max(n_did))) %>%
  ungroup() %>%
  unique() %>%
  # proportion seeking care
  mutate(prop_seek = n_did/n_did_survey) %>%
  # format variables
  mutate(outbreak_desc = ifelse(outbreak_desc == 1, 'Yes', 'No'),
         mult_choice = ifelse(mult_choice == 1, 'Yes', 'No'),
         case_cat = ifelse(case_cat == 'Giardiasis', 'Other (list etiologies in notes)', case_cat),
         pop_cat = ifelse(pop_cat %in% c('Child with malnutrition', 'Orphan', 'Relative/Caregiver (of adult)',
                                         'Street dweller', 'University student'), 'Other', pop_cat),
         recall_time = ifelse(recall_time < 14, '2-7 days',
                                   ifelse(recall_time == 14 | recall_time == 15, '14-15 days',
                                          ifelse(recall_time > 15 & recall_time <= 30, '27-30 days', 
                                                 ifelse(recall_time > 30 & recall_time <= 90, '42-90 days',
                                                        ifelse(recall_time > 90, '170-365 days', 'Unknown'))))),
         recall_time = factor(recall_time, 
                              levels = c('2-7 days', '14-15 days', '27-30 days', '42-90 days', '170-365 days', 'Unknown'))) %>%
  # factor variables
  mutate(study_type = factor(study_type,
                             levels = c('Survey', 'Surveillance',
                                        'Intervention', 'Case control')),
         sampling_method = factor(sampling_method,
                                  levels = c('Cluster', 'Systematic',
                                             'Simple random', 'All cases or households',
                                             'Stratified', 'Other')),
         location_desc = factor(location_desc,
                                levels = c('Rural', 'Urban', 'Urban and Rural',
                                           'Peri-Urban', 'Urban and Peri-Urban', 'IDP or Refugee Camp')))
         
```

```{r}
f2a <- plot_seekprop(df_hosp, 'study_type', num_colors=4)

# df_hosp %>%
#   group_by(study_type) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()

f2c <- plot_seekprop(df_hosp, 'sampling_method', num_colors=6)

# df_hosp %>%
#   group_by(sampling_method) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()

# # overall
# df_hosp %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r}
f2b <- plot_seekprop(df_hosp, 'outbreak_desc', num_colors=2) +
  ggtitle('Study describes an outbreak')

# df_hosp %>%
#   group_by(outbreak_desc) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r}
f2d <- plot_seekprop(df_hosp, 'location_desc', num_colors=6) +
  ggtitle('Location description')

# df_hosp %>%
#   group_by(location_desc) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r fig2, fig.width = 9, fig.height = 4}
cowplot::plot_grid(f2a, f2b,
                   labels = c('A', 'B'),
                   nrow = 1, rel_widths = c(0.6, 0.4))

cowplot::plot_grid(f2c, labels = c('C'))
cowplot::plot_grid(f2d, labels = c('D'))
```

```{r}
f2e <- plot_seekprop(df_hosp, 'pop_cat', num_colors=8) +
  ggtitle('Study population / respondent')

# df_hosp %>%
#   group_by(pop_cat) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r}
f2f <- plot_seekprop(df_hosp, 'case_cat', num_colors=8) +
  ggtitle('Diarrhea case definition')

# df_hosp %>%
#   group_by(case_cat) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r fig2-2, fig.width = 9, fig.height = 9}
cowplot::plot_grid(f2e, f2f,
                   labels = c('E', 'F'),
                   nrow = 2)
```

<br>

#### By type of care seeking questions

```{r}
f3a <- plot_seekprop(df_hosp, 'time_care', num_colors=3) +
  ggtitle('Timing of care seeking')

# df_hosp %>%
#   group_by(time_care) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r}
f3b <- plot_seekprop(df_hosp, 'self_or_child', num_colors=3) +
  ggtitle('Self, child, or other/combination')

# df_hosp %>%
#   group_by(self_or_child) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r}
f3c <- plot_seekprop(df_hosp, 'recall_time', num_colors=5) +
  ggtitle('Recall period')

# df_hosp %>%
#   group_by(recall_time) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r}
f3d <- plot_seekprop(df_hosp, 'mult_choice', num_colors=2) +
  ggtitle('Multiple choice')

# df_hosp %>%
#   group_by(mult_choice) %>%
#   summarize(median = median(prop_seek),
#             N = length(prop_seek),
#             IQR_L = quantile(prop_seek, 0.25),
#             IQR_R = quantile(prop_seek, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r fig3, fig.width = 9, fig.height = 4}
cowplot::plot_grid(f3a, f3b,
                   labels = c('A', 'B'),
                   nrow = 1)

cowplot::plot_grid(f3c, f3d,
                   labels = c('C', 'D'),
                   nrow = 1, rel_widths = c(0.64, 0.35))
```

<br>

## Preliminary analysis

Our goal is to estimate the proportion of individuals that seek care when they or their child have diarrhea symptoms. Since diarrhea symptoms vary, we have five broad categories of case definitions (below). Since some of these have few observations (cholera and "other"), we can't run stratifications (which would be ideal). Instead, we'll start by testing these along with other potential covariates in univariate analyses.

i.  Diarrhea (3+ loose stools in past 24 hours OR general/no explicit definition provided)
ii. Severe diarrhea (danger signs, dehydration, hospitalization, 1+ week duration, or death)
iii. Cholera (acute watery diarrhea of any severity, including resulting in death)
iv. Gastroenteritis (diarrhea or vomiting, including specific etiologies eg rotavirus or e coli)

We'll build generalized linear models with a study-level random intercept following the approach of Wiens *et al* (2023) *PLOS Medicine*:

1.  Unadjusted
2.  Univariate models adjusted individually for:

    a. Study methodology and population:
        -   study type
        -   case definition
        -   timing of care seeking
        -   recall period
        -   multiple choice questions
        -   study population

    b. Contextual factors:
        -   outbreak
        -   urban/rural

3. Multivatiate models adjusted for factors identified as significant in multivariate models.

*NB*: Here our observations represent data aggregated to study_id, country, and potnetial covariate stratifications, for a total of 161 unique observations corresponding to 136 studies. For studies with multiple choice questions, we take the maximum sample size and number seeking care for studies where there were multiple categories of "hospital/clinic" as possible answers.

```{r prep for Stan}
# use all cores but 2
pacman::p_load('cmdstanr', 'parallel')
options(mc.cores = parallel::detectCores() - 2)

# Stan settings
stan_redo <- FALSE # set this to TRUE to re-run the stan_run_id corresponding to the stan_model and draws
sa <- FALSE # whether or not to run sensitivity analysis
test <- FALSE # add a 'test' flag to run_id 

# model scripts
if (!sa) {
  model_script <- here::here('code', 'meta_analysis_re.stan')
} else {
  model_script <- here::here('code', 'meta_analysis_re_sa.stan')
}

# coefficient equations corresponding to each model
stan_mod_eqns <- list(
  'mod1' = '1',
  'mod2' = 'study_type + time_care + recall_time + case_cat',
  'mod3' = 'study_type + time_care + recall_time + case_cat + outbreak'
)
```

```{r prep data for Stan}
# set covariates
covs <- c('study_type', 'time_care', 'recall_time', 'pop_cat', 'mult_choice', # adjust for these
          'case_cat', 'outbreak_desc', 'location_desc') # examine differences by these (and age categories in separate analysis)

# proportion seeking care from meta-analysis primary dataset
# aggregate across stratifications that we're not including as covariates or stratifications
sr_dat <- df %>%
  # filter to hospital/clinic (not private) and diarrhea (general)
  filter(location_type %in% c('Hospital/Clinic', 'Public Hospital/Clinic')) %>%
  # format variables, combining some to reduce combinations
  mutate(case_cat = ifelse(case_cat %in% c('Giardiasis', 'Other (list etiologies in notes)'), 'Gastroenteritis', 
                           ifelse(case_cat %in% c('No explicit diarrhea definition', 'Diarrhea (3+ loose/liquid stools)'), 'Diarrhea',
                                  ifelse(case_cat %in% c('Diarrhea death', 'Severe diarrhea (danger signs, dehydration, hospitalization, 1+ week)'), 'Severe diarrhea',
                                         ifelse(case_cat %in% c('Cholera (watery diarrhea)', 'Cholera death'), 'V cholerae',
                                                                'Gastroenteritis')))),
         pop_cat = ifelse(pop_cat %in% c('Child with malnutrition', 'Orphan', 'Relative/Caregiver (of adult)',
                                         'Street dweller', 'University student', 'Other',
                                         'Resident', 'Resident with telephone/email access'), 'Other resident', pop_cat),
         location_desc = ifelse(location_desc == 'Urban', 'Urban',
                                ifelse(location_desc %in% c('Rural', 'Peri-Urban', 'IDP or Refugee Camp'), 'Non-urban', 
                                       'Mixed')),
         time_care = ifelse(time_care == 'prior to current visit', 'Any care', time_care),
         study_type = ifelse(study_type == 'Case control', 'Surveillance', study_type),
         recall_time = ifelse(recall_time <= 30, 'under30', 'over30_orNA'),
         recall_time = ifelse(is.na(recall_time), 'over30_orNA', recall_time)) %>%
  # aggregate care seeking numbers to study_id and covariate categories ("observations")
  group_by_at(c('study_id', 'country_iso3', 'region', covs)) %>%
  summarize(n_did_survey = ifelse(mult_choice == 0, sum(n_did_survey), max(n_did_survey)), 
            n_did = ifelse(mult_choice == 0, sum(n_did), max(n_did))) %>%
  ungroup() %>%
  unique()

# subset input data to diarrhea case definition
#stan_dat <- sr_dat %>% filter(case_cat == 'Diarrhea')
stan_dat <- sr_dat
case_strat <- 'all'

# add random effect label by observation
stan_dat <- stan_dat %>% mutate(study_lab = 1:nrow(stan_dat))
```

### Unadjusted estimates

```{r run unadjusted Stan models}

# run model 1 ----------------------------------------------------------

# which Stan model to run
stan_model <- 'mod1' 
stan_coef_eqn <- stan_mod_eqns[[stan_model]]

# set model id to include in filename
stan_run_id <- paste0(case_strat, '-', stan_model,
                      ifelse(sa, '-sa', ''),
                      ifelse(test, '-test', ''))

# file to save to
out_est_file <- here::here('data', 'generated_data', 'care_seeking_estimates',
                           paste0('propseek-', stan_run_id, '.rds'))

if (!file.exists(out_est_file) | stan_redo) {
  seekrate <- run_analysis_stan(
    model_script = model_script,
    dat_surveyed = stan_dat$n_did_survey,
    dat_soughtcare = stan_dat$n_did,
    dat_covars = stan_dat %>% select_at(covs),
    re_ids = stan_dat$study_lab,
    run_id = stan_run_id,
    coef_eqn = stan_coef_eqn,
    redo = stan_redo
  )

  saveRDS(seekrate, out_est_file)
  
  # check model convergence and other diagnostics
  stan_out_file <- here::here("data", "generated_data", "model_fits", 
                              paste0("stan_fit_", stan_run_id,".rds"))
  stan_est <- readRDS(stan_out_file)
  stan_est$cmdstan_diagnose()
  #shinystan::launch_shinystan(stan_est)

} else {
  seekrate <- readRDS(out_est_file)
}
```

```{r run univariate Stan models}

# loop over covariates
for (i in 1:length(covs)) {

#TODO: figure out why the stan install stopped working, then re-run the case_cat univariate analysis
#stan_redo <- TRUE
#for (i in c(6)) {
  
  stan_model <- paste0('uni-', covs[[i]])
  stan_coef_eqn <- covs[[i]]

  # set model id to include in filename
  stan_run_id <- paste0(case_strat, '-', stan_model,
                        ifelse(sa, '-sa', ''),
                        ifelse(test, '-test', ''))
  
  # file to save to
  out_est_file <- here::here('data', 'generated_data', 'care_seeking_estimates',
                             paste0('propseek-', stan_run_id, '.rds'))
  
  if (!file.exists(out_est_file) | stan_redo) {
    print(paste0('Running univariate model for: ', covs[[i]]))
    
    seekrate <- run_analysis_stan(
      model_script = model_script,
      dat_surveyed = stan_dat$n_did_survey,
      dat_soughtcare = stan_dat$n_did,
      dat_covars = stan_dat %>% select_at(covs[[i]]),
      re_ids = stan_dat$study_lab,
      run_id = stan_run_id,
      coef_eqn = stan_coef_eqn,
      redo = stan_redo
    )
  
    saveRDS(seekrate, out_est_file)
    
    # check model convergence and other diagnostics
    stan_out_file <- here::here("data", "generated_data", "model_fits", 
                                paste0("stan_fit_", stan_run_id,".rds"))
    stan_est <- readRDS(stan_out_file)
    stan_est$cmdstan_diagnose()
    #shinystan::launch_shinystan(stan_est)
  
  } else {
    seekrate <- readRDS(out_est_file)
  }
}

```

```{r run multivariate Stan models}
# run model 2 ----------------------------------------------------------

# which Stan model to run
stan_model <- 'mod2' 
stan_coef_eqn <- stan_mod_eqns[[stan_model]]

# set model id to include in filename
stan_run_id <- paste0(case_strat, '-', stan_model,
                      ifelse(sa, '-sa', ''),
                      ifelse(test, '-test', ''))

# file to save to
out_est_file <- here::here('data', 'generated_data', 'care_seeking_estimates',
                           paste0('propseek-', stan_run_id, '.rds'))

if (!file.exists(out_est_file) | stan_redo) {
  seekrate <- run_analysis_stan(
    model_script = model_script,
    dat_surveyed = stan_dat$n_did_survey,
    dat_soughtcare = stan_dat$n_did,
    dat_covars = stan_dat %>% select_at(covs),
    re_ids = stan_dat$study_lab,
    run_id = stan_run_id,
    coef_eqn = stan_coef_eqn,
    redo = stan_redo
  )

  saveRDS(seekrate, out_est_file)
  
  # check model convergence and other diagnostics
  stan_out_file <- here::here("data", "generated_data", "model_fits", 
                              paste0("stan_fit_", stan_run_id,".rds"))
  stan_est <- readRDS(stan_out_file)
  stan_est$cmdstan_diagnose()
  #shinystan::launch_shinystan(stan_est)

} else {
  seekrate <- readRDS(out_est_file)
}


# run model 3 ----------------------------------------------------------

# which Stan model to run
stan_model <- 'mod3' 
stan_coef_eqn <- stan_mod_eqns[[stan_model]]

# set model id to include in filename
stan_run_id <- paste0(case_strat, '-', stan_model,
                      ifelse(sa, '-sa', ''),
                      ifelse(test, '-test', ''))

# file to save to
out_est_file <- here::here('data', 'generated_data', 'care_seeking_estimates',
                           paste0('propseek-', stan_run_id, '.rds'))

if (!file.exists(out_est_file) | stan_redo) {
  seekrate <- run_analysis_stan(
    model_script = model_script,
    dat_surveyed = stan_dat$n_did_survey,
    dat_soughtcare = stan_dat$n_did,
    dat_covars = stan_dat %>% select_at(covs),
    re_ids = stan_dat$study_lab,
    run_id = stan_run_id,
    coef_eqn = stan_coef_eqn,
    redo = stan_redo
  )

  saveRDS(seekrate, out_est_file)
  
  # check model convergence and other diagnostics
  stan_out_file <- here::here("data", "generated_data", "model_fits", 
                              paste0("stan_fit_", stan_run_id,".rds"))
  stan_est <- readRDS(stan_out_file)
  stan_est$cmdstan_diagnose()
  #shinystan::launch_shinystan(stan_est)

} else {
  seekrate <- readRDS(out_est_file)
}

```

```{r data by covariate strata}

#TODO: update these with updated multivariate models

# strata1_dat <- stan_dat %>%
#   group_by(study_type, time_care, recall_time, mult_choice, pop_cat) %>%
#   summarize(weighted_mean = round(weighted.mean(n_did/n_did_survey, n_did_survey, na.rm=TRUE)*100,1),
#             median = round(median(n_did/n_did_survey)*100,1)) %>%
#   ungroup() %>%
#   arrange(study_type, time_care, recall_time, mult_choice, pop_cat)
# 
# strata2_dat <- stan_dat %>%
#   group_by(study_type, time_care, recall_time, mult_choice, outbreak_desc, location_desc) %>%
#   summarize(weighted_mean = round(weighted.mean(n_did/n_did_survey, n_did_survey, na.rm=TRUE)*100,1),
#             median = round(median(n_did/n_did_survey)*100,1)) %>%
#   ungroup() %>%
#   arrange(study_type, time_care, recall_time, mult_choice, outbreak_desc, location_desc)
```

```{r combine model results}
mod_ests <- data.frame(run_id = NA,
                      stan_id = NA,
                      mean = NA,
                      lower = NA,
                      upper = NA,
                      row.names = NULL)

file_names <- list.files(here::here('data', 'generated_data', 'care_seeking_estimates'))
file_names <- file_names[grep('all', file_names)]

for (i in file_names) {
  
  propseek <- readRDS(here::here('data', 'generated_data', 'care_seeking_estimates', i))
  model_name <- gsub('propseek-|\\.rds', '', i)
  
  # save alpha results
  mod_ests <- rbind(mod_ests,
                   data.frame(run_id = model_name,
                              stan_id = 'alpha',
                              mean = mean(inv.logit(propseek$alpha$alpha), na.rm = T),
                              lower = quantile(inv.logit(propseek$alpha$alpha), probs = .025, na.rm = T),
                              upper = quantile(inv.logit(propseek$alpha$alpha), probs = .975, na.rm = T),
                              row.names = NULL
                              )
                   )
  
  # save beta coefficients
  for (c in names(propseek$beta)) {
    if (c != '(Intercept)') {
      mod_ests <- rbind(mod_ests,
                       data.frame(
                         run_id = model_name,
                         stan_id = c,
                         mean = mean(propseek[['beta']][[c]], na.rm = T),
                         lower = quantile(propseek[['beta']][[c]], probs = .025, na.rm = T),
                         upper = quantile(propseek[['beta']][[c]], probs = .975, na.rm = T),
                         row.names = NULL
                       )
      )
    }
  }
  
}

```

```{r stratify}

# get the proportion of studies by covariate categories
# note: the function integrates over RE, post-stratifies, and stratifies, 
#       which is why we pull these, but in the paper we only present stratified results 
#       because they are more meaningful

# cats_mod2 <- obs_by_cat(stan_dat, c('study_type', 'time_care', 'recall_time', 'mult_choice', 
#                                     'pop_cat'))
# cats_mod3 <- obs_by_cat(stan_dat, c('study_type', 'time_care', 'recall_time', 'mult_choice',
#                                     'outbreak_desc', 'location_desc'))

# get overall Vc proportion positive for unadjusted model, integrating over random effects
prop_mod1 <- stratify('mod1', 'all', data.frame(alpha = 1, n = 1, prop = 1))[[1]]

# # post-stratify to get overall Vc proportion positive by strata
# prop_strat_mod2 <- stratify('mod2', 'dia', cats_mod2)[[2]]
# prop_strat_mod3 <- stratify('mod3', 'dia', cats_mod3)[[2]]

# save unadjusted post-stratified proportion to mod_est data frame
mod_ests <- rbind(mod_ests,
                  data.frame(run_id = 'all-mod1',
                             stan_id = 'prop',
                             mean = mean(prop_mod1$pos, na.rm = T),
                             lower = quantile(prop_mod1$pos, probs = .025, na.rm = T),
                             upper = quantile(prop_mod1$pos, probs = .975, na.rm = T),
                             row.names = NULL
                             )
                  )

# Commented code below until we run univariate models, decide on model configurations, etc.

# # stratifications below each correspond to:
# #     study_type = 'Survey'
# #     time_care = 'Any care'
# #     recall_time = 'under30'
# #     mult_choice = 0
# 
# prop_mod2_sub <- prop_strat_mod2 %>%
#   filter(study_typeSurvey == 1 & recall_timeunder30 == 1 & mult_choice == 0 &
#            `time_careFirst source` == 0 & `time_carePrior to current visit` == 0)
# 
# prop_mod3_sub <- prop_strat_mod3 %>%
#   filter(study_typeSurvey == 1 & recall_timeunder30 == 1 & mult_choice == 0 &
#            `time_careFirst source` == 0 & `time_carePrior to current visit` == 0)
# 
# # save estimates for each study population
# prop_mod2_sub <- prop_mod2_sub %>%
#   select_at(names(prop_mod2_sub)[grep("mean|lower|upper|pop_cat", names(prop_mod2_sub))])
# 
# pop_names <- names(prop_mod2_sub)[grep("pop_cat", names(prop_mod2_sub))] 
# pop_names <- gsub('pop_cat', '', pop_names)
# 
# mod_ests <- rbind(mod_ests,
#                   data.frame(run_id = c('Caregiver', pop_names),
#                              stan_id = rep('prop', nrow(prop_mod2_sub)),
#                              mean = prop_mod2_sub$mean,
#                              lower = prop_mod2_sub$lower,
#                              upper = prop_mod2_sub$upper,
#                              row.names = NULL
#                              )
#                   )
# 
# # save estimates for urban, non-outbreak
# row_id <- which(prop_mod3_sub$location_descUrban==1 & prop_mod3_sub$location_descRural==0 & prop_mod3_sub$outbreak_desc==0)
# mod_ests <- rbind(mod_ests,
#                   data.frame(run_id = 'Urban non-outbreak',
#                              stan_id = 'prop',
#                              mean = prop_mod3_sub[row_id, 'mean'],
#                              lower = prop_mod3_sub[row_id, 'lower'],
#                              upper = prop_mod3_sub[row_id, 'upper'],
#                              row.names = NULL
#                              )
#                   )
# 
# # save estimates for rural, non-outbreak
# row_id <- which(prop_mod3_sub$location_descUrban==0 & prop_mod3_sub$location_descRural==1 & prop_mod3_sub$outbreak_desc==0)
# mod_ests <- rbind(mod_ests,
#                   data.frame(run_id = 'Rural non-outbreak',
#                              stan_id = 'prop',
#                              mean = prop_mod3_sub[row_id, 'mean'],
#                              lower = prop_mod3_sub[row_id, 'lower'],
#                              upper = prop_mod3_sub[row_id, 'upper'],
#                              row.names = NULL
#                              )
#                   )
# 
# # save estimates for urban, outbreak
# row_id <- which(prop_mod3_sub$location_descUrban==1 & prop_mod3_sub$location_descRural==0 & prop_mod3_sub$outbreak_desc==1)
# mod_ests <- rbind(mod_ests,
#                   data.frame(run_id = 'Urban outbreak',
#                              stan_id = 'prop',
#                              mean = prop_mod3_sub[row_id, 'mean'],
#                              lower = prop_mod3_sub[row_id, 'lower'],
#                              upper = prop_mod3_sub[row_id, 'upper'],
#                              row.names = NULL
#                              )
#                   )
# 
# # save estimates for rural, outbreak
# row_id <- which(prop_mod3_sub$location_descUrban==0 & prop_mod3_sub$location_descRural==1 & prop_mod3_sub$outbreak_desc==1)
# mod_ests <- rbind(mod_ests,
#                   data.frame(run_id = 'Rural outbreak',
#                              stan_id = 'prop',
#                              mean = prop_mod3_sub[row_id, 'mean'],
#                              lower = prop_mod3_sub[row_id, 'lower'],
#                              upper = prop_mod3_sub[row_id, 'upper'],
#                              row.names = NULL
#                              )
#                   )

# tidy results
mod_ests <- mod_ests %>%
  drop_na() %>%
  mutate(mean=ifelse(stan_id == 'prop', round(mean*100,1), mean),
         lower=ifelse(stan_id == 'prop', round(lower*100,1), lower),
         upper=ifelse(stan_id == 'prop', round(upper*100,1), upper))
```

#### Posterior distributions of the proportion of people seeking care

```{r figS4, fig.width=7, fig.height=4}
# distributions of alpha
propseek1 <- readRDS(here::here('data', 'generated_data', 'care_seeking_estimates', 'propseek-all-mod1.rds'))

s4aL <- plot_prior_post(propseek1$alpha$alpha, 
                'logit(global intercept)',
                arg1=0, arg2=2, dprior='dnorm') +
  ggtitle('Unadjusted')


# distributions of the proportion seeking care
s4aR <- ggplot() +
  geom_histogram(aes(prop_mod1$pos))+
  xlim(c(0,1)) +
  theme_classic() +
  xlab('Proportion that sought care') + ggtitle('  ')


# plot
cowplot::plot_grid(s4aL, s4aR,
                   labels = c('A', ''), ncol = 2)
```

<br>

#### Estimated proportion that seek care

```{r tabS4}
# mean adjusted proportion positive
pr2 <- mod_ests %>%
  filter(run_id %in% c('all-mod1'), 
         stan_id == 'prop') %>%
  arrange(run_id) %>%
  dplyr::select(lower, mean, upper)

# mean adjusted proportion positive
pr2 <- pr2 %>%
  mutate(variable = c('Unadjusted')) %>%
  mutate(variable = factor(variable, levels = c('Unadjusted')))

# table S4
tabS4 <- data.frame('Version' = c('Unadjusted'),
                    'Proportion' = paste0(pr2[,2],' (',pr2[,1],' - ',pr2[,3],')'))

names(tabS4) <- c('Version', 'Proportion (%)')
pretty_table(tabS4)

# tabS4 %>%
#   flextable() %>%
#   save_as_docx(path = here::here('code/tables/tableS4.docx'))
```

<br>

### Univariate analyses

Odds of seeking care for diarrhea for each indicated variable, not adjusting for any other variables.

```{r univariate odds ratios, results='asis'}

mod_ests_uni <- mod_ests %>%
    filter(grepl('uni', run_id) & stan_id != 'alpha')

for (uni_id in unique(mod_ests_uni$run_id)) {

  cov <- gsub('all-uni-', '', uni_id)
  
  # pull coefficients
  coef_uni <- mod_ests_uni %>%
    filter(run_id == uni_id)
  
  # table of univariate ORs
  uni_or <- data.frame('Variable' = gsub(cov, '', coef_uni$stan_id),
                       'Odds ratio' = paste0(round(coef_uni[,3],2),' (',
                                             round(coef_uni[,4],2),' - ',
                                             round(coef_uni[,5],2),')'))
   
  print(pretty_table(uni_or, title = cov))
  cat('\n')
  
}

```

<br>



## Additional things to consider

Additional country- or study-level covariates:

-   Average travel time to health facilities
-   Policies on free or affordable healthcare
-   Ratio of medical practitioners or CHWs to population

Sub-analyses:

-   age
-   sex
-   severity
-   pre-post intervention

Sensitivity analyses:

-   study quality stratifications based on critical appraisals

Supplementary analyses:

-   would you seek care
-   assumptions about single-choice answers and where else people may seek care
